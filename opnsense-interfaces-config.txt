# OPNsense Interface Configuration
# VM: OPNsense-Firewall (VM ID: 100)
# Access: https://192.168.10.1 or https://10.0.99.10

# ============================================================
# VM Settings in Proxmox
# ============================================================
# CPU: 2-4 cores (host type)
# RAM: 4096 MB
# Disk: 32 GB (on fast storage)
# Start at boot: Yes
# Start/Shutdown order: 1 (start first, shutdown last)
#
# Network Adapters:
#   net0 -> vmbr0 (WAN) - VirtIO
#   net1 -> vmbr1 (LAN) - VirtIO
#   net2 -> vmbr2 (INTERNAL) - VirtIO
#   net3 -> vmbr99 (MGMT) - VirtIO

# ============================================================
# Interfaces -> Assignments
# ============================================================

## WAN Interface (vtnet0)
# IPv4 Configuration Type: DHCP
# IPv4 Address: (получает от ISP Router ~192.168.1.x)
# Block private networks: UNCHECKED (ISP router uses private IP)
# Block bogon networks: CHECKED

## LAN Interface (vtnet1)
# IPv4 Configuration Type: Static IPv4
# IPv4 Address: 192.168.10.1
# IPv4 Subnet: 24
# Description: "To OpenWRT WAN"

## INTERNAL Interface (vtnet2)
# IPv4 Configuration Type: Static IPv4
# IPv4 Address: 10.0.30.1
# IPv4 Subnet: 24
# Description: "LXC Containers Network"

## MGMT Interface (vtnet3)
# IPv4 Configuration Type: Static IPv4
# IPv4 Address: 10.0.99.10
# IPv4 Subnet: 24
# Description: "Proxmox Management Access"

# ============================================================
# Services -> DHCPv4 -> LAN
# ============================================================
# Enable: YES
# Range: 192.168.10.2 to 192.168.10.2 (only for OpenWRT)
# Gateway: 192.168.10.1
# DNS servers: 192.168.10.2 (OpenWRT with AdGuard)

# Static DHCP Mappings:
#   MAC Address: <OpenWRT_WAN_MAC_ADDRESS>
#   IP Address: 192.168.10.2
#   Hostname: openwrt-router
#   Description: OpenWRT Router

# ============================================================
# Services -> DHCPv4 -> INTERNAL
# ============================================================
# Enable: YES
# Range: 10.0.30.50 to 10.0.30.200
# Gateway: 10.0.30.1
# DNS servers: 192.168.10.2 (via routing through LAN)

# ============================================================
# Services -> Unbound DNS (optional, if not using AdGuard)
# ============================================================
# Enable: NO (using AdGuard on OpenWRT)
# If needed for internal resolution:
#   Listen Port: 53
#   Network Interfaces: INTERNAL, MGMT
#   Outgoing Network Interfaces: WAN
#   DNS Query Forwarding: Enable
#   Custom Forwarders: 192.168.10.2

# ============================================================
# Firewall -> NAT -> Outbound
# ============================================================
# Mode: Hybrid Outbound NAT

# Rules:
# 1. LAN net (192.168.10.0/24) -> WAN address (automatic NAT for OpenWRT)
# 2. INTERNAL net (10.0.30.0/24) -> WAN address (NAT for LXC containers)

# ============================================================
# Firewall -> Rules -> WAN
# ============================================================
# Default: Block all inbound

# Rule: Allow established/related
#   Action: Pass
#   Interface: WAN
#   Protocol: any
#   Source: any
#   Destination: any
#   Advanced: State Type = keep state

# Rule: Allow WireGuard VPN (for travel OpenWRT)
#   Action: Pass
#   Interface: WAN
#   Protocol: UDP
#   Source: any
#   Destination: WAN address
#   Destination port: 51820
#   Description: "WireGuard VPN for Travel Router"

# ============================================================
# Firewall -> Rules -> LAN (to OpenWRT)
# ============================================================

# Rule: LAN to INTERNAL Services
#   Action: Pass
#   Interface: LAN
#   Protocol: any
#   Source: LAN net
#   Destination: INTERNAL net
#   Description: "Allow OpenWRT clients to access LXC services"

# Rule: LAN to Internet
#   Action: Pass
#   Interface: LAN
#   Protocol: any
#   Source: LAN net
#   Destination: any
#   Description: "Allow internet access"

# Rule: LAN to Proxmox Web UI
#   Action: Pass
#   Interface: LAN
#   Protocol: TCP
#   Source: LAN net
#   Destination: 10.0.99.1
#   Destination port: 8006
#   Description: "Access to Proxmox Web UI"

# Rule: LAN to OPNsense Web UI
#   Action: Pass
#   Interface: LAN
#   Protocol: TCP
#   Source: LAN net
#   Destination: LAN address
#   Destination port: 443
#   Description: "Access to OPNsense Web UI"

# ============================================================
# Firewall -> Rules -> INTERNAL (LXC containers)
# ============================================================

# Rule: INTERNAL to Internet (limited)
#   Action: Pass
#   Interface: INTERNAL
#   Protocol: TCP/UDP
#   Source: INTERNAL net
#   Destination: any
#   Destination port: 80, 443, 53
#   Description: "Allow LXC containers to update and resolve DNS"

# Rule: Block INTERNAL to MGMT
#   Action: Reject
#   Interface: INTERNAL
#   Protocol: any
#   Source: INTERNAL net
#   Destination: MGMT net
#   Description: "Prevent LXC from accessing management network"

# Rule: Allow INTERNAL to LAN (for services accessible from clients)
#   Action: Pass
#   Interface: INTERNAL
#   Protocol: TCP
#   Source: INTERNAL net
#   Destination: LAN net
#   Destination port: 80, 443, 5432, 6379, 3306
#   Description: "Allow LXC services to respond to LAN clients"

# ============================================================
# Firewall -> Rules -> MGMT
# ============================================================

# Rule: MGMT full access
#   Action: Pass
#   Interface: MGMT
#   Protocol: any
#   Source: MGMT net
#   Destination: any
#   Description: "Full access from management network"

# ============================================================
# VPN -> WireGuard (for travel OpenWRT)
# ============================================================
# Instance Name: wg_travel
# Listen Port: 51820
# Tunnel Address: 10.0.200.1/24
# Peers:
#   Name: openwrt_travel
#   Public Key: <OpenWRT_WireGuard_Public_Key>
#   Allowed IPs: 10.0.200.10/32
#   Endpoint: (leave empty - client initiated)
#   Persistent Keepalive: 25

# Firewall rule for WireGuard interface:
#   Interface: WG_TRAVEL
#   Action: Pass
#   Source: WG_TRAVEL net
#   Destination: LAN net, INTERNAL net, MGMT net
#   Description: "Travel router full access"

# ============================================================
# System -> Settings -> Administration
# ============================================================
# Protocol: HTTPS
# TCP Port: 443
# Web GUI SSL Certificate: Generate Let's Encrypt or use self-signed
# DNS Rebinding Checks: Disable (for accessing via different interfaces)

# ============================================================
# System -> Firmware -> Plugins
# ============================================================
# Recommended plugins:
# - os-wireguard (WireGuard VPN)
# - os-haproxy (if using as reverse proxy)
# - os-acme-client (Let's Encrypt certificates)
# - os-vnstat (bandwidth monitoring)
# - os-theme-cicada or os-theme-vicuna (better UI themes)
