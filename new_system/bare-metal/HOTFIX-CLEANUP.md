# Hotfix #10-11: Temporary ISO cleanup improvements

## –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### Hotfix #10: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –≤ /tmp

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
Error: No space left on device (os error 28)
```

`proxmox-auto-install-assistant` –∫–æ–ø–∏—Ä—É–µ—Ç ISO (~1.6GB) –≤ `/tmp`, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å—Ç–æ —è–≤–ª—è–µ—Ç—Å—è tmpfs (RAM-–¥–∏—Å–∫) —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º.

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `/var/tmp/` –≤–º–µ—Å—Ç–æ `/tmp/` (–æ–±—ã—á–Ω–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –¥–∏—Å–∫–µ)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ `/var/tmp` –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ (>2GB):
if [[ $(df --output=avail /var/tmp | tail -1) -gt 2000000 ]]; then
    TMPDIR=$(mktemp -d /var/tmp/pmxiso.XXXX)
else
    TMPDIR=$(mktemp -d ./pmxiso.XXXX)  # Fallback –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
fi
```

---

### Hotfix #11: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ ISO

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í—Ä–µ–º–µ–Ω–Ω—ã–π ISO (~1.6GB) –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤ `/tmp` –∏–ª–∏ `/var/tmp` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:**
–£–ª—É—á—à–µ–Ω `cleanup()`:

```bash
cleanup() {
    # 1. –£–¥–∞–ª—è–µ—Ç TMPDIR (–≤–∫–ª—é—á–∞—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π ISO)
    if [[ -n "${TMPDIR:-}" && -d "${TMPDIR:-}" ]]; then
        printf '%s\n' "INFO: Cleaning up temporary files in $TMPDIR..." >&2
        rm -rf "${TMPDIR}"
    fi

    # 2. –û—á–∏—â–∞–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–ø—É—Å–∫–æ–≤
    for pattern in /tmp/pmxiso.* /var/tmp/pmxiso.* ./pmxiso.*; do
        for dir in $pattern; do
            [[ -d "$dir" ]] && rm -rf "$dir" 2>/dev/null || true
        done
    done

    # 3. –†–∞–∑–º–æ–Ω—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ mount points
    for dir in /tmp/usbmnt.* /tmp/usb-uuid.*; do
        if [[ -d "$dir" ]] && mountpoint -q "$dir" 2>/dev/null; then
            umount "$dir" 2>/dev/null || true
        fi
        [[ -d "$dir" ]] && rmdir "$dir" 2>/dev/null || true
    done
}
```

**–ö–æ–≥–¥–∞ cleanup() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:**
- –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (EXIT)
- –ü—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏ Ctrl+C (INT)
- –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ SIGTERM (TERM)
- –ü—Ä–∏ –æ—à–∏–±–∫–µ (EXIT —Å –∫–æ–¥–æ–º != 0)

---

## –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö Hotfix

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|---|----------|---------|-------------|
| 1 | IFS syntax error | `IFS=$'\n\t'` | üî¥ –ö–†–ò–¢–ò–ß–ù–û |
| 2 | cleanup() unmount glob | –¶–∏–∫–ª —Å mountpoint check | ‚ö†Ô∏è –í–ê–ñ–ù–û |
| 3 | add_graphics –¥–≤–∞ sed | –û–¥–∏–Ω sed —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º | ‚ö†Ô∏è –í–ê–ñ–ù–û |
| 4 | unquoted for loop | `while read` | ‚ö†Ô∏è –í–ê–ñ–ù–û |
| 5 | grep –≤–º–µ—Å—Ç–æ findmnt | `findmnt` | ‚ö†Ô∏è –í–ê–ñ–ù–û |
| 6 | --outdir –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç | `--output "$file" --tmp "$dir"` | üî¥ –ö–†–ò–¢–ò–ß–ù–û |
| 7 | INPUT –ø–æ—Ä—è–¥–æ–∫ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ | INPUT –ø–æ—Å–ª–µ–¥–Ω–∏–º | üî¥ –ö–†–ò–¢–ò–ß–ù–û |
| 8 | pipe —Ç–µ—Ä—è–µ—Ç exit code | –ó–∞—Ö–≤–∞—Ç –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é | üî¥ –ö–†–ò–¢–ò–ß–ù–û |
| 9 | auto-installer-mode.toml –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `add_auto_installer_mode()` | üî¥ –ö–†–ò–¢–ò–ß–ù–û |
| **10** | **No space left (tmpfs)** | **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /var/tmp** | **üî¥ –ö–†–ò–¢–ò–ß–ù–û** |
| **11** | **–í—Ä–µ–º–µ–Ω–Ω—ã–π ISO –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è** | **–£–ª—É—á—à–µ–Ω cleanup()** | **‚ö†Ô∏è –í–ê–ñ–ù–û** |

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ cleanup:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç:
sudo ./create-usb-final.sh proxmox.iso answer.toml /dev/sdX

# –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ temp —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã:
ls -la /var/tmp/pmxiso.* 2>/dev/null
# –û–∂–∏–¥–∞–µ—Ç—Å—è: No such file or directory

ls -la ./pmxiso.* 2>/dev/null
# –û–∂–∏–¥–∞–µ—Ç—Å—è: No such file or directory
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ:

```bash
# –î–æ –∑–∞–ø—É—Å–∫–∞:
df -h /var/tmp

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å > 2GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞

# –í–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:
watch -n 1 "df -h /var/tmp; ls -lh /var/tmp/pmxiso.*"

# –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
df -h /var/tmp
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
```

---

## –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û—á–∏—Å—Ç–∏—Ç—å /var/tmp

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –º–µ—Å—Ç–æ:
sudo du -sh /var/tmp/* 2>/dev/null | sort -h | tail -10

# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã:
sudo find /var/tmp -type f -mtime +7 -delete
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä tmpfs

```bash
# –í—Ä–µ–º–µ–Ω–Ω–æ (–¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏):
sudo mount -o remount,size=4G /tmp

# –ü–æ—Å—Ç–æ—è–Ω–Ω–æ (–¥–æ–±–∞–≤–∏—Ç—å –≤ /etc/fstab):
tmpfs /tmp tmpfs defaults,size=4G 0 0
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –º–µ—Å—Ç–æ–º:
cd ~/Downloads
sudo /path/to/create-usb-final.sh proxmox.iso answer.toml /dev/sdX

# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ./pmxiso.* –µ—Å–ª–∏ /var/tmp –º–∞–ª–æ
```

---

## –°–æ–æ–±—â–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞

**–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏:**
```
INFO: Successfully wrote ... to /dev/sdb
INFO: Adding auto-installer-mode.toml to USB...
INFO: auto-installer-mode.toml is present on USB
INFO: Adding graphics parameters...
INFO: GRUB configuration updated
========================================
USB READY FOR AUTOMATED INSTALLATION
========================================
Note: Temporary ISO will be automatically cleaned up on exit.
INFO: Cleaning up temporary files in /var/tmp/pmxiso.XXXX...
```

**–ü—Ä–∏ –æ—à–∏–±–∫–µ:**
```
ERROR: ...
create-usb-final.sh: ERROR: Exited with status 9
INFO: Cleaning up temporary files in /var/tmp/pmxiso.XXXX...
```

---

## –†–∞–∑–º–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

**–¢—Ä–µ–±—É–µ—Ç—Å—è –º–µ—Å—Ç–æ:**
- –ò—Å—Ö–æ–¥–Ω—ã–π ISO: ~1.6 GB
- –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã: ~1.6 GB (–∫–æ–ø–∏—è ISO)
- –í—ã—Ö–æ–¥–Ω–æ–π ISO: ~1.6 GB
- **–ò—Ç–æ–≥–æ: ~3.2 GB** –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã

**–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
- –í—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã
- –û—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ USB —Å –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–º ISO

---

## –†–µ–∑—é–º–µ

‚úÖ **Hotfix #10**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/var/tmp` –≤–º–µ—Å—Ç–æ `/tmp` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è tmpfs limits
‚úÖ **Hotfix #11**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ —É–ª—É—á—à–µ–Ω–Ω—ã–π `cleanup()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –º–∞–ª–æ–º —Ä–∞–∑–º–µ—Ä–µ `/tmp`
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤—Å–µ–≥–¥–∞ —É–¥–∞–ª—è—é—Ç—Å—è
- –û—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ª—é–±–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞/Ctrl+C)
