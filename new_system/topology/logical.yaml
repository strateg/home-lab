# Logical Topology
# Part of Home Lab Topology v3.0.0
# This file is part of the modular topology structure
# Edit this file and regenerate topology.yaml with: python3 scripts/merge-topology.py
#
# Architecture v3.0: MikroTik Chateau LTE7 ax as central router
# - No OPNsense VM (removed to free Proxmox RAM)
# - MikroTik handles routing, firewall, WiFi, LTE failover
# - Orange Pi 5 as dedicated application server
# - Proxmox for databases and dev/lab VMs


  # ------------------------------------------------------------
  # Trust Zones & Security Boundaries
  # ------------------------------------------------------------

  trust_zones:
    untrusted:
      name: "Untrusted Zone"
      security_level: 0
      color: "#ff0000"
      description: "External networks (ISP, Internet, LTE)"
      allowed_outbound: ["any"]
      allowed_inbound: ["established", "related"]

    user:
      name: "User Zone"
      security_level: 1
      color: "#ffcc00"
      description: "End-user devices (WiFi, LAN, VPN clients)"
      allowed_outbound: ["to:untrusted", "to:servers:ports:80,443,5432,6379"]
      allowed_inbound: ["established"]

    servers:
      name: "Servers Zone"
      security_level: 2
      color: "#00cc00"
      description: "Proxmox LXC and Orange Pi 5 services"
      allowed_outbound: ["to:untrusted"]
      allowed_inbound: ["from:user:ports:80,443,5432,6379", "from:management"]

    iot:
      name: "IoT Zone"
      security_level: 1
      color: "#ff6600"
      description: "Smart home devices (isolated)"
      allowed_outbound: ["to:untrusted"]
      allowed_inbound: ["established"]
      isolated: true

    guest:
      name: "Guest Zone"
      security_level: 0
      color: "#999999"
      description: "Guest WiFi (isolated, internet only)"
      allowed_outbound: ["to:untrusted"]
      allowed_inbound: ["established"]
      isolated: true

    management:
      name: "Management Zone"
      security_level: 3
      color: "#0066cc"
      description: "Infrastructure management (Proxmox UI, MikroTik UI)"
      allowed_outbound: ["any"]
      allowed_inbound: ["from:admin-ips"]

  # ------------------------------------------------------------
  # Networks
  # ------------------------------------------------------------

  networks:
    # WAN Network (ISP)
    - id: net-wan
      name: "WAN (ISP)"
      cidr: "dhcp"
      gateway: "dhcp"
      dns: ["1.1.1.1", "8.8.8.8"]
      dhcp: true
      trust_zone_ref: untrusted
      bridge_ref: null  # Direct to MikroTik WAN port
      vlan: null
      description: "Primary ISP connection via MikroTik ether1 (2.5GbE)"
      managed_by_ref: mikrotik-chateau
      interface_ref: if-mikrotik-wan

    # LTE Failover
    - id: net-lte-failover
      name: "LTE Failover"
      cidr: "dhcp"
      gateway: "dhcp"
      dns: ["1.1.1.1", "8.8.8.8"]
      dhcp: true
      trust_zone_ref: untrusted
      bridge_ref: null
      vlan: null
      description: "LTE Cat 7 failover connection"
      managed_by_ref: mikrotik-chateau
      interface_ref: if-mikrotik-lte
      failover:
        enabled: true
        primary: net-wan
        check_gateway: "ping"
        failover_threshold: 3

    # Main LAN (Users + Servers)
    - id: net-lan
      name: "LAN"
      cidr: "192.168.88.0/24"
      gateway: "192.168.88.1"
      dns: ["192.168.88.1"]  # MikroTik forwards to AdGuard container
      dhcp: true
      dhcp_range: "192.168.88.100-192.168.88.200"
      trust_zone_ref: user
      bridge_ref: null  # MikroTik bridge
      vlan: null
      description: "Main LAN network (WiFi + Wired)"
      managed_by_ref: mikrotik-chateau
      ip_allocations:
        - ip: "192.168.88.1"
          device_ref: mikrotik-chateau
          interface: "bridge-lan"
          description: "MikroTik LAN gateway"
        - ip: "192.168.88.2"
          device_ref: gamayun
          interface: "eth0"
          description: "Proxmox host"
        - ip: "192.168.88.3"
          device_ref: orangepi5
          interface: "eth0"
          description: "Orange Pi 5 application server"

    # Servers VLAN (Proxmox LXC + Orange Pi 5 services)
    - id: net-servers
      name: "Servers"
      cidr: "10.0.30.0/24"
      gateway: "10.0.30.1"
      dns: ["192.168.88.1"]  # MikroTik AdGuard
      dhcp: false
      trust_zone_ref: servers
      bridge_ref: bridge-vmbr2
      vlan: 30
      description: "Server network for Proxmox LXC and Orange Pi 5"
      managed_by_ref: mikrotik-chateau
      ip_allocations:
        - ip: "10.0.30.1"
          device_ref: mikrotik-chateau
          interface: "vlan30"
          description: "MikroTik servers gateway"
        - ip: "10.0.30.2"
          device_ref: gamayun
          interface: "vmbr2"
          description: "Proxmox bridge IP"
        - ip: "10.0.30.10"
          device_ref: lxc-postgresql
          interface: "eth0"
          description: "PostgreSQL LXC"
        - ip: "10.0.30.20"
          device_ref: lxc-redis
          interface: "eth0"
          description: "Redis LXC"
        - ip: "10.0.30.50"
          device_ref: orangepi5
          interface: "eth0.30"
          description: "Orange Pi 5 server interface"

    # Guest WiFi (Isolated)
    - id: net-guest
      name: "Guest WiFi"
      cidr: "192.168.30.0/24"
      gateway: "192.168.30.1"
      dns: ["1.1.1.1", "8.8.8.8"]  # Public DNS, no local access
      dhcp: true
      dhcp_range: "192.168.30.100-192.168.30.200"
      isolated: true
      trust_zone_ref: guest
      bridge_ref: null
      vlan: 30
      description: "Isolated guest WiFi network"
      managed_by_ref: mikrotik-chateau
      firewall_policy: "internet-only"
      ip_allocations:
        - ip: "192.168.30.1"
          device_ref: mikrotik-chateau
          interface: "vlan30-guest"
          description: "MikroTik guest gateway"

    # IoT Network (Isolated)
    - id: net-iot
      name: "IoT Network"
      cidr: "192.168.40.0/24"
      gateway: "192.168.40.1"
      dns: ["192.168.88.1"]
      dhcp: true
      dhcp_range: "192.168.40.100-192.168.40.200"
      isolated: true
      trust_zone_ref: iot
      bridge_ref: null
      vlan: 40
      description: "Smart home devices (isolated from main LAN)"
      managed_by_ref: mikrotik-chateau
      firewall_policy: "internet-only-no-lateral"
      ip_allocations:
        - ip: "192.168.40.1"
          device_ref: mikrotik-chateau
          interface: "vlan40-iot"
          description: "MikroTik IoT gateway"

    # Management Network
    - id: net-management
      name: "Management"
      cidr: "10.0.99.0/24"
      gateway: "10.0.99.1"
      dns: ["192.168.88.1"]
      dhcp: false
      trust_zone_ref: management
      bridge_ref: bridge-vmbr99
      vlan: 99
      description: "Management network for infrastructure admin"
      managed_by_ref: mikrotik-chateau
      ip_allocations:
        - ip: "10.0.99.1"
          device_ref: mikrotik-chateau
          interface: "vlan99-mgmt"
          description: "MikroTik management gateway"
        - ip: "10.0.99.2"
          device_ref: gamayun
          interface: "vmbr99"
          description: "Proxmox Web UI"
        - ip: "10.0.99.3"
          device_ref: orangepi5
          interface: "eth0.99"
          description: "Orange Pi 5 management"

    # VPN Home (WireGuard on MikroTik)
    - id: net-vpn-home
      name: "VPN Home"
      cidr: "10.0.200.0/24"
      gateway: "10.0.200.1"
      dns: ["192.168.88.1"]
      dhcp: false
      trust_zone_ref: user
      bridge_ref: null
      vlan: null
      description: "WireGuard VPN on MikroTik (full LAN access)"
      managed_by_ref: mikrotik-chateau
      vpn_type: "wireguard"
      vpn_endpoint: "home.example.com:51820"
      ip_allocations:
        - ip: "10.0.200.1"
          device_ref: mikrotik-chateau
          interface: "wireguard1"
          description: "WireGuard server"

    # Tailscale Mesh (Container on MikroTik)
    - id: net-tailscale
      name: "Tailscale Mesh"
      cidr: "100.64.0.0/10"  # Tailscale CGNAT range
      gateway: null
      dns: ["100.100.100.100"]  # MagicDNS
      dhcp: false
      trust_zone_ref: user
      bridge_ref: null
      vlan: null
      description: "Tailscale mesh VPN (container on MikroTik)"
      managed_by_ref: mikrotik-chateau
      vpn_type: "tailscale"

  # ------------------------------------------------------------
  # Bridges (Proxmox VE)
  # ------------------------------------------------------------
  # Note: MikroTik is now the central router
  # Proxmox bridges are for internal VM/LXC networking only

  bridges:
    - id: bridge-vmbr0
      device_ref: gamayun
      name: "vmbr0"
      comment: "LAN Bridge - to MikroTik (Built-in Ethernet)"
      ports: ["if-eth-builtin"]
      address: "192.168.88.2/24"
      gateway: "192.168.88.1"
      network_ref: net-lan
      autostart: true
      vlan_aware: true
      bridge_stp: false
      bridge_fd: 0

    - id: bridge-vmbr2
      device_ref: gamayun
      name: "vmbr2"
      comment: "Servers Bridge - LXC Containers (VLAN 30)"
      ports: []
      address: "10.0.30.2/24"
      gateway: "10.0.30.1"
      network_ref: net-servers
      autostart: true
      vlan_aware: false
      bridge_stp: false
      bridge_fd: 0

    - id: bridge-vmbr99
      device_ref: gamayun
      name: "vmbr99"
      comment: "Management Bridge (VLAN 99)"
      ports: []
      address: "10.0.99.2/24"
      gateway: "10.0.99.1"
      network_ref: net-management
      autostart: true
      vlan_aware: false
      bridge_stp: false
      bridge_fd: 0

  # ------------------------------------------------------------
  # Routing
  # ------------------------------------------------------------
  # MikroTik handles all inter-VLAN routing
  # Proxmox only needs default route to MikroTik

  routing:
    - id: route-proxmox-default
      name: "Proxmox Default Route"
      device_ref: gamayun
      destination_cidr: "0.0.0.0/0"
      next_hop: "192.168.88.1"
      gateway_device_ref: mikrotik-chateau
      description: "All Proxmox traffic routes through MikroTik"

    - id: route-lxc-internet
      name: "LXC to Internet"
      source_network_ref: net-servers
      destination_cidr: "0.0.0.0/0"
      next_hop: "10.0.30.1"
      gateway_device_ref: mikrotik-chateau
      description: "LXC containers route through MikroTik"

    - id: route-user-servers
      name: "User LAN to Servers"
      source_network_ref: net-lan
      destination_network_ref: net-servers
      via: "192.168.88.1"
      gateway_device_ref: mikrotik-chateau
      description: "User devices access servers via MikroTik inter-VLAN routing"

    - id: route-lte-failover
      name: "LTE Failover Route"
      device_ref: mikrotik-chateau
      destination_cidr: "0.0.0.0/0"
      next_hop: "lte1"
      priority: 10
      check_gateway: "ping"
      description: "Automatic failover to LTE when ISP is down"

  # ------------------------------------------------------------
  # DNS Records
  # ------------------------------------------------------------

  dns:
    zones:
      - id: zone-home-local
        domain: "home.local"
        nameserver_ref: svc-adguard
        type: "forward"
        description: "Primary home lab DNS zone (AdGuard on MikroTik)"

        records:
          # Network Devices
          - type: "A"
            name: "router"
            ip: "192.168.88.1"
            device_ref: mikrotik-chateau
            ttl: 3600
            description: "MikroTik router"

          - type: "A"
            name: "mikrotik"
            ip: "192.168.88.1"
            device_ref: mikrotik-chateau
            ttl: 3600
            description: "MikroTik router alias"

          # Physical Servers
          - type: "A"
            name: "gamayun"
            ip: "192.168.88.2"
            device_ref: gamayun
            ttl: 3600
            description: "Proxmox host"

          - type: "A"
            name: "proxmox"
            ip: "10.0.99.2"
            device_ref: gamayun
            ttl: 3600
            description: "Proxmox Web UI (management)"

          - type: "A"
            name: "orangepi"
            ip: "192.168.88.3"
            device_ref: orangepi5
            ttl: 3600
            description: "Orange Pi 5 application server"

          - type: "A"
            name: "opi5"
            ip: "10.0.30.50"
            device_ref: orangepi5
            ttl: 3600
            description: "Orange Pi 5 server interface"

          # LXC Containers (Proxmox)
          - type: "A"
            name: "postgresql"
            ip: "10.0.30.10"
            lxc_ref: lxc-postgresql
            ttl: 3600
            description: "PostgreSQL database server"

          - type: "A"
            name: "redis"
            ip: "10.0.30.20"
            lxc_ref: lxc-redis
            ttl: 3600
            description: "Redis cache server"

          # Services on Orange Pi 5
          - type: "A"
            name: "nextcloud"
            ip: "10.0.30.50"
            device_ref: orangepi5
            ttl: 3600
            description: "Nextcloud on Orange Pi 5"

          - type: "A"
            name: "jellyfin"
            ip: "10.0.30.50"
            device_ref: orangepi5
            ttl: 3600
            description: "Jellyfin media server on Orange Pi 5"

          - type: "A"
            name: "grafana"
            ip: "10.0.30.50"
            device_ref: orangepi5
            ttl: 3600
            description: "Grafana on Orange Pi 5"

          - type: "A"
            name: "prometheus"
            ip: "10.0.30.50"
            device_ref: orangepi5
            ttl: 3600
            description: "Prometheus on Orange Pi 5"

          # CNAME Records
          - type: "CNAME"
            name: "db"
            target: "postgresql.home.local"
            service_ref: svc-postgresql
            ttl: 3600
            description: "Database alias"

          - type: "CNAME"
            name: "cache"
            target: "redis.home.local"
            service_ref: svc-redis
            ttl: 3600
            description: "Cache alias"

          - type: "CNAME"
            name: "cloud"
            target: "nextcloud.home.local"
            service_ref: svc-nextcloud
            ttl: 3600
            description: "Cloud storage alias"

          - type: "CNAME"
            name: "media"
            target: "jellyfin.home.local"
            service_ref: svc-jellyfin
            ttl: 3600
            description: "Media server alias"

          - type: "CNAME"
            name: "monitor"
            target: "grafana.home.local"
            service_ref: svc-grafana
            ttl: 3600
            description: "Monitoring alias"

          # SRV Records for Service Discovery
          - type: "SRV"
            name: "_postgresql._tcp"
            target: "postgresql.home.local"
            port: 5432
            priority: 10
            weight: 10
            service_ref: svc-postgresql
            ttl: 3600
            description: "PostgreSQL service discovery"

          - type: "SRV"
            name: "_redis._tcp"
            target: "redis.home.local"
            port: 6379
            priority: 10
            weight: 10
            service_ref: svc-redis
            ttl: 3600
            description: "Redis service discovery"

          - type: "SRV"
            name: "_https._tcp.nextcloud"
            target: "nextcloud.home.local"
            port: 443
            priority: 10
            weight: 10
            service_ref: svc-nextcloud
            ttl: 3600
            description: "Nextcloud HTTPS service"

    # DNS Forwarders (upstream from AdGuard)
    forwarders:
      upstream_doh:
        - "https://dns.cloudflare.com/dns-query"
        - "https://dns.google/dns-query"
      upstream_dot:
        - "tls://1.1.1.1"
        - "tls://8.8.8.8"
      fallback:
        - "1.1.1.1"
        - "8.8.8.8"

    # DNS Settings
    settings:
      provider: "adguard-home"
      location: "mikrotik-container"
      recursion: true
      dnssec: true
      cache_size_mb: 100
      negative_ttl: 300
      allow_query_from:
        - "10.0.0.0/8"
        - "192.168.0.0/16"
        - "100.64.0.0/10"  # Tailscale

  # ------------------------------------------------------------
  # Firewall Templates
  # ------------------------------------------------------------

  firewall_templates:
    - id: tmpl-web-access
      name: "Web Access Template"
      description: "Allow HTTP and HTTPS traffic"
      ports: [80, 443]
      protocols: ["tcp"]
      action: "allow"

    - id: tmpl-database-access
      name: "Database Access Template"
      description: "Allow common database ports"
      ports: [5432, 3306, 6379, 27017]
      protocols: ["tcp"]
      action: "allow"

    - id: tmpl-ssh-access
      name: "SSH Access Template"
      description: "Allow SSH connections"
      ports: [22]
      protocols: ["tcp"]
      action: "allow"
      rate_limit:
        enabled: true
        max_connections: 10
        per_seconds: 60

    - id: tmpl-management-access
      name: "Management Access Template"
      description: "Allow management protocols (SSH, HTTPS, RDP)"
      ports: [22, 443, 8006, 3389]
      protocols: ["tcp"]
      action: "allow"

    - id: tmpl-icmp-allow
      name: "ICMP Allow Template"
      description: "Allow ping and traceroute"
      protocols: ["icmp"]
      action: "allow"
      icmp_types: [0, 8]  # Echo reply, Echo request

  # ------------------------------------------------------------
  # Firewall Policies (MikroTik RouterOS)
  # ------------------------------------------------------------

  firewall_policies:
    - id: fw-default-deny
      name: "Default Deny"
      priority: 1000
      action: "drop"
      chain: "forward"
      description: "Drop all traffic by default, allow explicitly"

    - id: fw-established-related
      name: "Allow Established/Related"
      priority: 1
      action: "accept"
      chain: "forward"
      connection_state: ["established", "related"]
      description: "Allow established and related connections"

    - id: fw-servers-internet
      name: "Servers to Internet"
      priority: 100
      source_zone_ref: servers
      destination_zone_ref: untrusted
      action: "accept"
      chain: "forward"
      description: "Servers can access internet"

    - id: fw-user-servers
      name: "User to Server Services"
      priority: 200
      source_zone_ref: user
      destination_zone_ref: servers
      ports: [80, 443, 5432, 6379, 8096, 3000, 9090]
      protocols: ["tcp"]
      action: "accept"
      chain: "forward"
      description: "User devices can access server services"

    - id: fw-guest-isolated
      name: "Guest Isolation"
      priority: 300
      source_zone_ref: guest
      destination_zones_ref: [servers, management, user, iot]
      action: "drop"
      chain: "forward"
      description: "Guest network cannot access any internal networks"

    - id: fw-iot-isolated
      name: "IoT Isolation"
      priority: 300
      source_zone_ref: iot
      destination_zones_ref: [servers, management, user, guest]
      action: "drop"
      chain: "forward"
      description: "IoT cannot access other networks (except internet)"

    - id: fw-iot-internet
      name: "IoT to Internet"
      priority: 301
      source_zone_ref: iot
      destination_zone_ref: untrusted
      action: "accept"
      chain: "forward"
      description: "IoT can access internet"

    - id: fw-management-admin
      name: "Management Access Control"
      priority: 50
      source_network_ref: net-lan
      destination_zone_ref: management
      ports: [8006, 443, 22, 80]
      protocols: ["tcp"]
      action: "accept"
      chain: "forward"
      description: "Allow admin access from LAN to management interfaces"

    - id: fw-vpn-full-access
      name: "VPN Full Access"
      priority: 60
      source_network_ref: net-vpn-home
      destination_zones_ref: [user, servers, management]
      action: "accept"
      chain: "forward"
      description: "VPN clients have full network access"

    - id: fw-tailscale-access
      name: "Tailscale Access"
      priority: 61
      source_network_ref: net-tailscale
      destination_zones_ref: [user, servers]
      action: "accept"
      chain: "forward"
      description: "Tailscale mesh clients can access LAN and servers"

# ============================================================
# Compute (VMs and LXC Containers)
# ============================================================

