# Compute Resources
# Part of Home Lab Topology v3.0.0
# This file is part of the modular topology structure
# Edit this file and regenerate topology.yaml with: python3 scripts/merge-topology.py
#
# Architecture v3.0:
# - MikroTik Chateau LTE7 ax handles routing/firewall (no OPNsense VM needed)
# - Orange Pi 5 runs application services (Nextcloud, Jellyfin, monitoring)
# - Proxmox runs only database LXC containers (PostgreSQL, Redis)
# - This frees ~5-6GB RAM on Proxmox for dev/lab VMs


  # ============================================================
  # YAML Anchors - Reusable Configuration Defaults
  # ============================================================

  _defaults:
    # Common OS configuration for LXC containers
    lxc_os: &default_lxc_os
      type: "debian"
      version: "12"

    # Common DNS configuration (MikroTik AdGuard)
    dns: &default_dns
      nameserver: "192.168.88.1"
      searchdomain: "home.local"

    # Common boot configuration for LXC
    lxc_boot: &default_lxc_boot
      onboot: true
      startup_order: 10

    # Common storage rootfs configuration
    lxc_storage_rootfs: &default_lxc_storage_rootfs
      storage_ref: storage-lvm
      size_gb: 8

    # Common network configuration for LXC (servers network)
    lxc_network_servers: &default_lxc_network_servers
      interface: "eth0"
      bridge_ref: bridge-vmbr2
      network_ref: net-servers
      gateway: "10.0.30.1"  # MikroTik
      firewall: false

    # Common cloud-init configuration
    lxc_cloudinit: &default_lxc_cloudinit
      enabled: true

    # Common ansible configuration
    ansible_enabled: &default_ansible_enabled
      enabled: true

  # ------------------------------------------------------------
  # Virtual Machines
  # ------------------------------------------------------------
  # Note: OPNsense VM removed - MikroTik handles routing/firewall
  # RAM freed: ~2GB (was 1.5GB + overhead)

  vms: []
  # Future VMs can be added here for dev/lab purposes
  # Example:
  # - id: vm-dev-ubuntu
  #   vmid: 110
  #   name: "dev-ubuntu"
  #   ...


  # ------------------------------------------------------------
  # LXC Containers
  # ------------------------------------------------------------
  # Only database containers run on Proxmox
  # Application services (Nextcloud, Jellyfin, etc.) run on Orange Pi 5
  # This optimizes for:
  # - Low latency database access (SSD on Proxmox)
  # - Hardware transcoding on Orange Pi 5 (RK3588S VPU)
  # - Network resilience (critical DNS/VPN on MikroTik)

  lxc:
    - id: lxc-postgresql
      vmid: 200
      name: "postgresql-db"
      device_ref: gamayun
      type: "database"
      role: "database-server"
      template_ref: tpl-lxc-postgresql
      trust_zone_ref: servers
      description: "PostgreSQL Database Server"
      tags: ["database", "production"]

      resources:
        cores: 2
        memory_mb: 1024
        swap_mb: 1024

      boot:
        <<: *default_lxc_boot

      storage:
        rootfs:
          <<: *default_lxc_storage_rootfs

      networks:
        - <<: *default_lxc_network_servers
          ip: "10.0.30.10/24"

      dns: *default_dns

      os: *default_lxc_os

      cloudinit:
        <<: *default_lxc_cloudinit
        user: "postgres"
        ssh_keys:
          - "ssh-ed25519 AAAA..."  # Add your SSH key

      ansible:
        <<: *default_ansible_enabled
        playbook: "postgresql.yml"
        vars:
          postgresql_version: "16"
          postgresql_listen_addresses: "10.0.30.10"
          postgresql_databases:
            - name: "nextcloud"
            - name: "homelab"
          postgresql_users:
            - name: "nextcloud"
              password: "{{ vault_postgresql_nextcloud_password }}"
              database: "nextcloud"
            - name: "app"
              password: "{{ vault_postgresql_app_password }}"
              database: "homelab"
          postgresql_pg_hba:
            - type: "host"
              database: "nextcloud"
              user: "nextcloud"
              address: "10.0.30.50/32"  # Orange Pi 5
              method: "scram-sha-256"
            - type: "host"
              database: "all"
              user: "all"
              address: "10.0.30.0/24"
              method: "scram-sha-256"

    - id: lxc-redis
      vmid: 201
      name: "redis-cache"
      device_ref: gamayun
      type: "cache"
      role: "cache-server"
      template_ref: tpl-lxc-redis
      trust_zone_ref: servers
      description: "Redis Cache Server"
      tags: ["cache", "production"]

      resources:
        cores: 1
        memory_mb: 512
        swap_mb: 256

      boot:
        <<: *default_lxc_boot
        startup_order: 11

      storage:
        rootfs:
          <<: *default_lxc_storage_rootfs
          size_gb: 4

      networks:
        - <<: *default_lxc_network_servers
          ip: "10.0.30.20/24"

      dns: *default_dns

      os: *default_lxc_os

      cloudinit:
        <<: *default_lxc_cloudinit
        user: "redis"

      ansible:
        <<: *default_ansible_enabled
        playbook: "redis.yml"
        vars:
          redis_port: 6379
          redis_bind: "10.0.30.20"
          redis_maxmemory: "256mb"
          redis_maxmemory_policy: "allkeys-lru"

  # ------------------------------------------------------------
  # Orange Pi 5 Services (Docker Compose)
  # ------------------------------------------------------------
  # These services run on Orange Pi 5, not as Proxmox LXC
  # Defined here for documentation and Ansible inventory generation

  external_services:
    - id: ext-orangepi5
      device_ref: orangepi5
      description: "Application services on Orange Pi 5"
      ip: "10.0.30.50"

      docker_services:
        - name: "nextcloud"
          image: "nextcloud:28"
          ports: ["443:443", "80:80"]
          volumes:
            - "/mnt/nvme/nextcloud/data:/var/www/html/data"
            - "/mnt/nvme/nextcloud/config:/var/www/html/config"
          environment:
            POSTGRES_HOST: "10.0.30.10"
            REDIS_HOST: "10.0.30.20"
          depends_on: ["lxc-postgresql", "lxc-redis"]

        - name: "jellyfin"
          image: "jellyfin/jellyfin:latest"
          ports: ["8096:8096"]
          volumes:
            - "/mnt/nvme/jellyfin/config:/config"
            - "/mnt/nvme/jellyfin/cache:/cache"
            - "/mnt/nvme/media:/media"
          devices:
            - "/dev/dri:/dev/dri"  # Hardware transcoding
            - "/dev/mali0:/dev/mali0"
            - "/dev/rga:/dev/rga"
          note: "RK3588S VPU for hardware transcoding"

        - name: "prometheus"
          image: "prom/prometheus:latest"
          ports: ["9090:9090"]
          volumes:
            - "/mnt/nvme/prometheus:/prometheus"

        - name: "grafana"
          image: "grafana/grafana:latest"
          ports: ["3000:3000"]
          volumes:
            - "/mnt/nvme/grafana:/var/lib/grafana"

        - name: "home-assistant"
          image: "homeassistant/home-assistant:stable"
          ports: ["8123:8123"]
          volumes:
            - "/mnt/nvme/homeassistant:/config"
          optional: true
          note: "Enable if smart home devices are used"

  # ------------------------------------------------------------
  # Templates
  # ------------------------------------------------------------

  templates:
    lxc:
      - id: tpl-lxc-postgresql
        vmid: 900
        name: "template-postgresql"
        storage_ref: storage-hdd
        source: "proxmox-community-scripts"
        script: "db-postgresql.sh"
        description: "PostgreSQL LXC template"

      - id: tpl-lxc-redis
        vmid: 901
        name: "template-redis"
        storage_ref: storage-hdd
        source: "proxmox-community-scripts"
        script: "db-redis.sh"
        description: "Redis LXC template"

      - id: tpl-lxc-debian
        vmid: 902
        name: "template-debian"
        storage_ref: storage-hdd
        source: "proxmox"
        image: "debian-12-standard_12.2-1_amd64.tar.zst"
        description: "Debian 12 base LXC template"

    vms:
      - id: tpl-vm-debian
        vmid: 910
        name: "template-debian-vm"
        storage_ref: storage-hdd
        source: "cloud-init"
        image: "debian-12-genericcloud-amd64.qcow2"
        description: "Debian 12 cloud-init VM template"

      - id: tpl-vm-ubuntu
        vmid: 911
        name: "template-ubuntu-vm"
        storage_ref: storage-hdd
        source: "cloud-init"
        image: "ubuntu-24.04-server-cloudimg-amd64.img"
        description: "Ubuntu 24.04 cloud-init VM template"

# ============================================================
# Storage
# ============================================================

