# Backup Configuration
# Part of Home Lab Topology v3.0.0
# This file is part of the modular topology structure
#
# Backup Strategy:
# - MikroTik: RouterOS config export to Git (daily)
# - Orange Pi 5: Docker volumes + NVMe data to Proxmox HDD (daily)
# - Proxmox LXC: vzdump snapshots (hourly for DB, daily for others)
# - Offsite: Critical data to cloud storage (weekly)

  # ============================================================
  # 3-2-1 Backup Rule
  # ============================================================
  # 3 copies of data
  # 2 different storage media
  # 1 offsite backup

  strategy:
    rule: "3-2-1"
    copies: 3
    media:
      - id: media-proxmox-ssd
        type: "ssd"
        device_ref: gamayun
        path: "/dev/sda"
        role: "primary"
      - id: media-proxmox-hdd
        type: "hdd"
        device_ref: gamayun
        path: "/mnt/hdd"
        role: "local-backup"
      - id: media-cloud
        type: "cloud"
        provider: "backblaze-b2"  # or: s3, wasabi, gdrive
        role: "offsite"
        encrypted: true

  # ============================================================
  # Backup Policies
  # ============================================================

  policies:
    # MikroTik Configuration Backup
    - id: backup-mikrotik-config
      name: "MikroTik Config Backup"
      description: "Export RouterOS configuration to Git repository"
      targets:
        - device_ref: mikrotik-chateau
      type: "config-export"
      schedule: "0 4 * * *"  # 4 AM daily
      method: "routeros-export"
      export_format: "rsc"
      destination:
        type: "git"
        repository: "/home/dmpr/workspaces/projects/home-lab/backups/mikrotik"
        branch: "main"
        commit_message: "Automated MikroTik config backup - {{ date }}"
      retention:
        keep_commits: 90  # 90 days of history
      verification:
        syntax_check: true
      notification:
        on_success: false
        on_failure: true
        channels: ["email"]

    # Orange Pi 5 Data Backup
    - id: backup-orangepi5-data
      name: "Orange Pi 5 Data Backup"
      description: "Backup Docker volumes and NVMe data to Proxmox HDD"
      targets:
        - device_ref: orangepi5
      type: "rsync"
      schedule: "0 3 * * *"  # 3 AM daily
      source_paths:
        - "/mnt/nvme/nextcloud"
        - "/mnt/nvme/jellyfin/config"
        - "/mnt/nvme/grafana"
        - "/mnt/nvme/prometheus"
        - "/mnt/nvme/homeassistant"
      destination:
        type: "rsync"
        target: "root@192.168.88.2:/mnt/hdd/backups/orangepi5"
        ssh_key: "/root/.ssh/id_ed25519"
      options:
        incremental: true
        compress: true
        delete_old: false
        bandwidth_limit_kbps: 50000  # 50 MB/s to not overload
      retention:
        keep_daily: 7
        keep_weekly: 4
      notification:
        on_success: false
        on_failure: true
        channels: ["email"]

    # PostgreSQL Database Backup - Hourly
    - id: backup-hourly-postgresql
      name: "Hourly PostgreSQL Backups"
      description: "Hourly pg_dump for critical database"
      targets:
        - lxc_ref: lxc-postgresql
      type: "pg_dump"
      schedule: "0 * * * *"  # Every hour
      databases:
        - "nextcloud"
        - "homelab"
      destination:
        storage_ref: storage-hdd
        path: "/mnt/hdd/backups/postgresql"
      compression: "zstd"
      retention:
        keep_last: 24       # Last 24 hours
        keep_daily: 7       # 7 days
      notification:
        on_success: false
        on_failure: true
        channels: ["email"]

    # PostgreSQL LXC Snapshot - Daily
    - id: backup-daily-postgresql-lxc
      name: "Daily PostgreSQL LXC Snapshot"
      description: "Full LXC snapshot for disaster recovery"
      targets:
        - lxc_ref: lxc-postgresql
      type: "vzdump"
      schedule: "0 2 * * *"  # 2 AM daily
      storage_ref: storage-hdd
      mode: "snapshot"
      compression: "zstd"
      retention:
        keep_last: 3
        keep_daily: 7
        keep_weekly: 4
      notification:
        on_success: false
        on_failure: true
        channels: ["email"]

    # Redis LXC Backup - Daily
    - id: backup-daily-redis
      name: "Daily Redis Backup"
      description: "Daily backup of Redis LXC"
      targets:
        - lxc_ref: lxc-redis
      type: "vzdump"
      schedule: "0 2 30 * * *"  # 2:30 AM daily
      storage_ref: storage-hdd
      mode: "snapshot"
      compression: "zstd"
      retention:
        keep_last: 3
        keep_daily: 7
      notification:
        on_success: false
        on_failure: true
        channels: ["email"]

    # Weekly Full Backup
    - id: backup-weekly-full
      name: "Weekly Full Infrastructure Backup"
      description: "Complete weekly backup of all LXC containers"
      targets:
        - lxc_ref: lxc-postgresql
        - lxc_ref: lxc-redis
      type: "vzdump"
      schedule: "0 1 * * 0"  # Sunday at 1 AM
      storage_ref: storage-hdd
      mode: "snapshot"
      compression: "zstd"
      retention:
        keep_last: 4
        keep_weekly: 8
        keep_monthly: 6
      notification:
        on_success: true
        on_failure: true
        channels: ["email"]

    # Offsite Backup - Weekly
    - id: backup-offsite-weekly
      name: "Weekly Offsite Backup"
      description: "Critical data to cloud storage (encrypted)"
      targets:
        - "postgresql-dumps"
        - "mikrotik-config"
        - "nextcloud-data"
      type: "rclone"
      schedule: "0 5 * * 0"  # Sunday at 5 AM
      source_paths:
        - "/mnt/hdd/backups/postgresql"
        - "/mnt/hdd/backups/mikrotik"
        - "/mnt/hdd/backups/orangepi5/nextcloud"
      destination:
        type: "cloud"
        provider: "backblaze-b2"
        bucket: "homelab-backups"
        path: "/weekly"
      encryption:
        enabled: true
        method: "rclone-crypt"
        password_file: "/root/.config/rclone/crypt-password"
      retention:
        keep_weekly: 8
        keep_monthly: 6
      notification:
        on_success: true
        on_failure: true
        channels: ["email"]

  # ============================================================
  # Backup Verification
  # ============================================================

  verification:
    enabled: true
    schedule: "0 6 * * 1"  # Monday at 6 AM
    checks:
      - type: "integrity"
        description: "Verify backup file integrity"
      - type: "restore_test"
        description: "Test restore to temporary location"
        enabled: false  # Enable for periodic testing
        frequency: "monthly"
    notification:
      on_success: false
      on_failure: true
      channels: ["email"]

  # ============================================================
  # Storage Monitoring
  # ============================================================

  storage_monitoring:
    enabled: true
    locations:
      - path: "/mnt/hdd/backups"
        warning_percent: 70
        critical_percent: 85
      - path: "cloud:homelab-backups"
        warning_gb: 50
        critical_gb: 100
    notification:
      channels: ["email"]

# ============================================================
# Monitoring & Health Checks
# ============================================================

