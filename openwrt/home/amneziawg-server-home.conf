# AmneziaWG Server на GL-AXT1800 Slate AX (HOME MODE)
# Назначение: VPN сервер для клиентов в России (обход DPI блокировок)
# Файл: /etc/amnezia/amneziawg/awg0.conf

[Interface]
# Адрес сервера в VPN сети
Address = 10.8.2.1/24

# Порт для прослушивания (отличается от WireGuard!)
ListenPort = 51821

# Приватный ключ сервера (ЗАМЕНИТЬ!)
PrivateKey = SLATE_AX_AWG_SERVER_PRIVATE_KEY_CHANGE_ME

# MTU
MTU = 1420

# ============================================================
# AMNEZIAWG ОБФУСКАЦИЯ ПАРАМЕТРЫ
# ============================================================
# Эти параметры маскируют VPN трафик под обычный UDP
# ВАЖНО: Должны совпадать на сервере и клиенте!

# Junk packets - количество мусорных пакетов
Jc = 5

# Junk packet size range - размер мусорных пакетов (байты)
Jmin = 50
Jmax = 1000

# Init packet junk size - размер мусора в начальном пакете
S1 = 100

# Response packet junk size - размер мусора в ответном пакете
S2 = 100

# Magic headers - магические заголовки для маскировки
H1 = 1122334455  # Init packet magic header
H2 = 9876543210  # Response packet magic header
H3 = 1122334455  # Underload packet magic header
H4 = 5544332211  # Transport packet magic header

# ============================================================
# FIREWALL И ROUTING
# ============================================================

PostUp = iptables -A FORWARD -i awg0 -j ACCEPT
PostUp = iptables -A FORWARD -o awg0 -j ACCEPT
PostUp = iptables -t nat -A POSTROUTING -s 10.8.2.0/24 -o br-lan -j MASQUERADE

# Разрешаем доступ к домашней сети
PostUp = ip route add 10.0.30.0/24 via 192.168.10.1 dev br-lan
PostUp = ip route add 10.0.99.0/24 via 192.168.10.1 dev br-lan

PostDown = iptables -D FORWARD -i awg0 -j ACCEPT
PostDown = iptables -D FORWARD -o awg0 -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -s 10.8.2.0/24 -o br-lan -j MASQUERADE
PostDown = ip route del 10.0.30.0/24 via 192.168.10.1 dev br-lan
PostDown = ip route del 10.0.99.0/24 via 192.168.10.1 dev br-lan

# ============================================================
# PEERS - AmneziaWG клиенты (родственники/друзья в России)
# ============================================================

# Peer 1: Родственник в Москве
[Peer]
PublicKey = RUSSIA_CLIENT_1_PUBLIC_KEY_CHANGE_ME
PresharedKey = RUSSIA_CLIENT_1_PSK_CHANGE_ME
AllowedIPs = 10.8.2.10/32
PersistentKeepalive = 25

# Peer 2: Родственник в Санкт-Петербурге
[Peer]
PublicKey = RUSSIA_CLIENT_2_PUBLIC_KEY_CHANGE_ME
PresharedKey = RUSSIA_CLIENT_2_PSK_CHANGE_ME
AllowedIPs = 10.8.2.20/32
PersistentKeepalive = 25

# Peer 3: Друг в регионе
[Peer]
PublicKey = RUSSIA_CLIENT_3_PUBLIC_KEY_CHANGE_ME
PresharedKey = RUSSIA_CLIENT_3_PSK_CHANGE_ME
AllowedIPs = 10.8.2.30/32
PersistentKeepalive = 25

# Peer 4: Резервный клиент
#[Peer]
#PublicKey = RUSSIA_CLIENT_4_PUBLIC_KEY_CHANGE_ME
#PresharedKey = RUSSIA_CLIENT_4_PSK_CHANGE_ME
#AllowedIPs = 10.8.2.40/32
#PersistentKeepalive = 25

# ============================================================
# ИНСТРУКЦИЯ ПО НАСТРОЙКЕ
# ============================================================
#
# 1. Установите AmneziaWG на Slate AX:
#    ssh root@192.168.20.1
#    cd /tmp
#    wget https://github.com/amnezia-vpn/amneziawg-linux-kernel-module/releases/download/v1.0.20231030/kmod-amneziawg_5.10.176-1_mipsel_24kc.ipk
#    wget https://github.com/amnezia-vpn/amneziawg-tools/releases/download/v1.0.20231030/amneziawg-tools_1.0.20231030-1_mipsel_24kc.ipk
#    opkg install kmod-amneziawg_*.ipk amneziawg-tools_*.ipk
#
# 2. Генерация ключей сервера:
#    mkdir -p /etc/amnezia/amneziawg
#    awg genkey | tee /etc/amnezia/amneziawg/server_privatekey | awg pubkey > /etc/amnezia/amneziawg/server_publickey
#
# 3. Замените SLATE_AX_AWG_SERVER_PRIVATE_KEY_CHANGE_ME на:
#    cat /etc/amnezia/amneziawg/server_privatekey
#
# 4. Для каждого клиента:
#    # Генерация ключей
#    awg genkey | tee client1_privatekey | awg pubkey > client1_publickey
#    awg genpsk > client1_preshared
#
#    # Замените PUBLIC_KEY и PSK в конфигурации
#
# 5. Скопируйте конфиг на Slate AX:
#    scp amneziawg-server-home.conf root@192.168.20.1:/etc/amnezia/amneziawg/awg0.conf
#
# 6. Запустите AmneziaWG:
#    awg-quick up awg0
#
# 7. Добавьте в автозагрузку:
#    cat > /etc/init.d/amneziawg <<'EOF'
#    #!/bin/sh /etc/rc.common
#    START=99
#    start() {
#        awg-quick up awg0
#    }
#    stop() {
#        awg-quick down awg0
#    }
#    EOF
#    chmod +x /etc/init.d/amneziawg
#    /etc/init.d/amneziawg enable
#
# 8. Проверьте статус:
#    awg show awg0
#
# 9. Настройте Port Forward на OPNsense:
#    WAN → 192.168.10.2:51821 (UDP)
#
# ============================================================
# КЛИЕНТСКАЯ КОНФИГУРАЦИЯ (пример для России)
# ============================================================
#
# [Interface]
# PrivateKey = CLIENT_PRIVATE_KEY
# Address = 10.8.2.10/32
# DNS = 1.1.1.1, 8.8.8.8
#
# Jc = 5
# Jmin = 50
# Jmax = 1000
# S1 = 100
# S2 = 100
# H1 = 1122334455
# H2 = 9876543210
# H3 = 1122334455
# H4 = 5544332211
#
# [Peer]
# PublicKey = SLATE_AX_AWG_SERVER_PUBLIC_KEY
# PresharedKey = CLIENT_PRESHARED_KEY
# Endpoint = your-home-ddns.com:51821
# AllowedIPs = 0.0.0.0/0
# PersistentKeepalive = 25
#
# ============================================================
# ЗАЧЕМ AMNEZIAWG В РОССИИ?
# ============================================================
#
# AmneziaWG обходит DPI (Deep Packet Inspection) блокировки:
# - Маскирует VPN трафик под обычный UDP
# - Работает там, где обычный WireGuard заблокирован
# - Почти такая же скорость как WireGuard
# - Подходит для России, Китая, Ирана
#
# Обычный WireGuard:
# - ❌ Легко определяется DPI
# - ❌ Блокируется в России
#
# AmneziaWG:
# - ✅ Обходит DPI блокировки
# - ✅ Работает в России
# - ✅ ~5-10% медленнее WireGuard (терпимо)
#
# ============================================================
# ИСПОЛЬЗОВАНИЕ
# ============================================================
#
# Клиенты в России получают:
# - Доступ в интернет без блокировок
# - Безопасное соединение
# - Обход цензуры
# - Доступ к домашней сети (опционально)
#
# Для доступа только к интернету:
# AllowedIPs = 0.0.0.0/0
#
# Для доступа к домашней сети + интернет:
# AllowedIPs = 0.0.0.0/0
#
# Для доступа только к домашней сети:
# AllowedIPs = 192.168.20.0/24, 10.0.30.0/24, 10.0.99.0/24
#
# ============================================================
