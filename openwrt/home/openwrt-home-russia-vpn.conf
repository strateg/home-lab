# OpenWRT Home Mode - Russia VPN Configuration
# Для подключения к Russia VPS ДОМА (через OPNsense firewall)
# Дополнительная конфигурация к openwrt-home-*
# Файл: /etc/amnezia/amneziawg-russia/awg1.conf

[Interface]
PrivateKey = CLIENT_PRIVATE_KEY_CHANGE_ME
Address = 10.9.1.2/24
DNS = 8.8.8.8, 1.1.1.1

# Обфускация параметры (ДОЛЖНЫ СОВПАДАТЬ с сервером!)
Jc = 7
Jmin = 60
Jmax = 1200
S1 = 40
S2 = 60
H1 = 9876543210
H2 = 1234567890
H3 = 5544332211
H4 = 1122334455

# Routing table для Russia VPN (чтобы не конфликтовать с основным интернетом)
Table = off  # Управляем маршрутами вручную

[Peer]
PublicKey = SERVER_PUBLIC_KEY_CHANGE_ME
PresharedKey = PRESHARED_KEY_CHANGE_ME
Endpoint = RUSSIA_VPS_IP:51822
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25

# ============================================================
# ОСОБЕННОСТИ HOME MODE С RUSSIA VPN
# ============================================================

# В Home Mode OpenWRT находится за OPNsense:
#
# Internet → ISP → Proxmox WAN → OPNsense → Proxmox LAN → OpenWRT → Клиенты
#
# Трафик к Russia VPS должен пройти через OPNsense firewall:
# OpenWRT (192.168.10.2) → OPNsense (192.168.10.1) → Internet → Russia VPS

# ВАЖНО:
# 1. На OPNsense должны быть разрешены исходящие UDP 51822
# 2. NAT на OPNsense автоматически обработает трафик
# 3. OpenWRT использует OPNsense как default gateway (192.168.10.1)

# ============================================================
# ИНСТРУКЦИЯ ПО НАСТРОЙКЕ
# ============================================================

# 1. Убедитесь что вы в HOME MODE:
#
# cat /etc/openwrt-mode
# # Должно показать: home

# 2. Создать директорию (если ещё не создана):
#
# mkdir -p /etc/amnezia/amneziawg-russia
# cd /etc/amnezia/amneziawg-russia

# 3. Создать ключи (если ещё не созданы):
#
# awg genkey | tee client_privatekey | awg pubkey > client_publickey
# cat client_publickey  # Добавить на Russia VPS сервер

# 4. Скопировать этот конфиг:
#
# # С компьютера:
# scp openwrt-home-russia-vpn.conf root@192.168.20.1:/etc/amnezia/amneziawg-russia/awg1.conf
#
# # На роутере:
# chmod 600 /etc/amnezia/amneziawg-russia/awg1.conf

# 5. Заменить ключи и IP в конфиге:
#
# nano /etc/amnezia/amneziawg-russia/awg1.conf
#
# CLIENT_PRIVATE_KEY_CHANGE_ME = client_privatekey
# SERVER_PUBLIC_KEY_CHANGE_ME = server_publickey с Russia VPS
# PRESHARED_KEY_CHANGE_ME = preshared_key с Russia VPS
# RUSSIA_VPS_IP = публичный IP российского VPS

# 6. Настроить OPNsense firewall (см. opnsense-russia-vpn-firewall.txt):
#
# На OPNsense через Web UI:
# Firewall → Rules → LAN → Add
# Protocol: UDP, Source: LAN net, Destination: any, Dest port: 51822
# Description: "Allow Russia VPN from OpenWRT"

# 7. Запустить Russia VPN:
#
# awg-quick up awg1

# 8. Проверить подключение:
#
# awg show awg1
# ping 10.9.1.1  # Russia VPS сервер
# curl ifconfig.me  # Должен показать российский IP

# 9. Остановить:
#
# awg-quick down awg1

# ============================================================
# ROUTING ЧЕРЕЗ OPNSENSE
# ============================================================

# В Home Mode маршрутизация работает автоматически:
#
# 1. OpenWRT default gateway: 192.168.10.1 (OPNsense LAN)
# 2. OPNsense LAN: 192.168.10.1/24
# 3. OPNsense WAN: 192.168.1.x (от ISP)
#
# Когда запускается Russia VPN:
# OpenWRT → создаёт AmneziaWG туннель (awg1)
# Пакеты к Russia VPS → через default gateway (OPNsense)
# OPNsense → NAT → Internet → Russia VPS
#
# Обратный путь:
# Russia VPS → Internet → OPNsense WAN → NAT → OPNsense LAN → OpenWRT awg1

# Проверить маршруты:
# ip route show
# ip route get RUSSIA_VPS_IP
# # Должно показать: via 192.168.10.1 (OPNsense)

# ============================================================
# FIREWALL НА OPENWRT (ДОПОЛНИТЕЛЬНЫЕ ПРАВИЛА)
# ============================================================

# Добавить в /etc/config/firewall:

# # Russia VPN zone
# config zone
#     option name 'russiavpn'
#     option input 'ACCEPT'
#     option output 'ACCEPT'
#     option forward 'REJECT'
#     option masq '0'  # Не нужен masq, OPNsense сделает NAT
#     option mtu_fix '1'
#     list network 'russiavpn'
#
# # Разрешить forwarding LAN → Russia VPN
# config forwarding
#     option src 'lan'
#     option dest 'russiavpn'
#
# # Разрешить исходящие UDP 51822 к Russia VPS
# config rule
#     option name 'Allow Russia VPN'
#     option src 'wan'  # wan = connection to OPNsense
#     option dest '*'
#     option proto 'udp'
#     option dest_port '51822'
#     option target 'ACCEPT'

# Перезапустить firewall:
# /etc/init.d/firewall restart

# ============================================================
# NETWORK INTERFACE (ОПЦИОНАЛЬНО)
# ============================================================

# Добавить в /etc/config/network:

# config interface 'russiavpn'
#     option proto 'none'
#     option device 'awg1'
#     option auto '0'  # Не автозапуск

# /etc/init.d/network reload

# ============================================================
# ИСПОЛЬЗОВАНИЕ С VPN SELECTOR
# ============================================================

# VPN Selector работает и в Home Mode!
#
# vpn russia   # Запустить Russia VPN (через OPNsense)
# vpn oracle   # Запустить Oracle VPN (через OPNsense)
# vpn home     # Запустить Home VPN (к OPNsense WireGuard)
# vpn status   # Проверить статус
# vpn off      # Отключить все VPN

# ============================================================
# ОТЛИЧИЯ ОТ TRAVEL MODE
# ============================================================

# Travel Mode:
#   OpenWRT WAN → прямо в Internet (отель/кафе WiFi)
#   Russia VPN → напрямую к VPS (без промежуточных firewall)
#   Используется: когда вы ВНЕ дома
#
# Home Mode:
#   OpenWRT WAN → OPNsense LAN (192.168.10.2 → 192.168.10.1)
#   Russia VPN → через OPNsense → Internet → VPS
#   Используется: когда вы ДОМА, но нужен РФ IP

# ============================================================
# ЗАЧЕМ НУЖЕН RUSSIA VPN ДОМА?
# ============================================================

# Сценарии использования:
#
# 1. Тестирование:
#    - Проверить как работает сервис с российским IP
#    - Отладка конфигурации Russia VPN
#
# 2. Доступ к РФ сервисам:
#    - Банки РФ (если вы временно за границей, но роутер дома)
#    - Стриминговые сервисы
#
# 3. Обход geo-блокировок:
#    - Некоторые сервисы блокируют не-РФ регионы
#    - С Russia VPN → выглядите как пользователь из России

# ============================================================
# ПРОВЕРКА РАБОТЫ
# ============================================================

# 1. Проверить что OPNsense доступен:
# ping 192.168.10.1

# 2. Проверить что интернет работает:
# ping 8.8.8.8

# 3. Запустить Russia VPN:
# awg-quick up awg1

# 4. Проверить интерфейс:
# ip addr show awg1
# awg show awg1

# 5. Проверить handshake:
# awg show awg1 latest-handshakes
# # Должен быть недавний handshake

# 6. Проверить маршрут к Russia VPS:
# ip route get RUSSIA_VPS_IP
# # Должно показать: via 192.168.10.1 dev eth0.1 (через OPNsense)

# 7. Ping Russia VPS:
# ping 10.9.1.1

# 8. Проверить внешний IP:
# curl ifconfig.me
# curl ipinfo.io/country
# # Должно показать: RU

# 9. Traceroute (опционально):
# traceroute -n 8.8.8.8
# # Первый hop: 10.9.1.1 (Russia VPS)
# # Второй hop: российские IP адреса

# ============================================================
# TROUBLESHOOTING
# ============================================================

# Проблема: AmneziaWG запускается, но нет handshake
# Решение:
#   # Проверить firewall на OPNsense
#   # Firewall → Rules → LAN → должно быть правило для UDP 51822
#
#   # На OPNsense посмотреть логи
#   # Firewall → Log Files → Live View
#   # Должны быть пакеты от 192.168.10.2:* → RUSSIA_VPS_IP:51822
#
#   # Если пакеты блокируются, добавить правило:
#   # Protocol: UDP, Source: 192.168.10.2, Dest: any, Port: 51822, Action: Pass

# Проблема: Handshake есть, но нет интернета
# Решение:
#   # Проверить DNS
#   nslookup google.com
#
#   # Проверить маршруты
#   ip route show | grep awg1
#
#   # Проверить что Russia VPS forwarding включен
#   # На Russia VPS:
#   sudo sysctl net.ipv4.ip_forward  # Должно быть 1

# Проблема: Медленная скорость
# Решение:
#   # Двойной NAT может замедлять
#   # OpenWRT → OPNsense NAT → ISP NAT → Internet
#
#   # Уменьшить MTU
#   ip link set awg1 mtu 1400
#
#   # Уменьшить обфускацию
#   # В конфиге изменить: Jc = 3, Jmax = 800

# Проблема: Конфликт с Oracle VPN (awg0)
# Решение:
#   # Только ОДИН AmneziaWG может быть активен
#   # Сначала остановить Oracle:
#   awg-quick down awg0
#   # Потом запустить Russia:
#   awg-quick up awg1
#
#   # Или использовать VPN Selector:
#   vpn russia  # Автоматически остановит Oracle и запустит Russia

# ============================================================
# БЕЗОПАСНОСТЬ
# ============================================================

# 1. Firewall на OPNsense:
#    - Разрешить ТОЛЬКО исходящий UDP 51822
#    - НЕ разрешать входящий 51822 (не нужен)
#
# 2. Изоляция:
#    - Russia VPN трафик идёт через отдельный туннель
#    - Локальные устройства не видны из Russia VPS
#
# 3. DNS leaks:
#    - DNS настроен в конфиге (8.8.8.8)
#    - Не использует локальный DNS
#
# 4. Kill switch (опционально):
#    - Если Russia VPN упадёт, заблокировать интернет
#    - См. openwrt-home-firewall для примера

# ============================================================
# МОНИТОРИНГ
# ============================================================

# Простой мониторинг:
# watch -n 5 'awg show awg1'

# Логи:
# logread | grep -i amnezia
# logread | grep -i awg

# Статистика:
# awg show awg1 transfer
# awg show awg1 latest-handshakes

# ============================================================
# BACKUP
# ============================================================

# Backup конфигурации:
# tar -czf /tmp/russia-vpn-backup.tar.gz /etc/amnezia/amneziawg-russia/

# Скачать backup:
# scp root@192.168.20.1:/tmp/russia-vpn-backup.tar.gz ./

# ============================================================
# ИНТЕГРАЦИЯ С HOME MODE SWITCHER
# ============================================================

# Russia VPN работает независимо от mode switcher
# Можно использовать в любом режиме:
#
# Home Mode + Russia VPN → через OPNsense
# Travel Mode + Russia VPN → напрямую
#
# VPN Selector автоматически определяет режим и использует правильный конфиг

# ============================================================
# АЛЬТЕРНАТИВА: ИСПОЛЬЗОВАТЬ OPNSENSE KAK VPN CLIENT
# ============================================================

# Вместо AmneziaWG на OpenWRT можно настроить на OPNsense:
#
# Преимущества:
# - Весь дом получает российский IP
# - Централизованное управление через OPNsense UI
# - Меньше нагрузка на OpenWRT
#
# Недостатки:
# - Сложнее настройка (нужно компилировать AmneziaWG для OPNsense)
# - Меньше гибкости (все устройства через Russia VPN)
#
# Для большинства случаев рекомендуется текущий вариант (AmneziaWG на OpenWRT)

# ============================================================
# ПОЛЕЗНЫЕ ССЫЛКИ
# ============================================================

# Руководства:
# - HOME-RUSSIA-VPN-SETUP.md - полная инструкция
# - RUSSIA-VPS-SETUP.md - настройка Russia VPS сервера
# - opnsense-russia-vpn-firewall.txt - правила firewall для OPNsense
#
# Конфигурации:
# - russia-vps-amneziawg.conf - серверная конфигурация
# - openwrt-home-russia-vpn.conf - этот файл (клиент для home mode)
# - openwrt-travel-russia-client.conf - клиент для travel mode
#
# Скрипты:
# - openwrt-vpn-selector.sh - переключение между VPN
