# WireGuard Server на GL-AXT1800 Slate AX (HOME MODE)
# Назначение: VPN доступ к домашней сети из Travel mode
# Файл: /etc/wireguard/wg0.conf

[Interface]
# Адрес сервера в VPN сети
Address = 10.0.200.1/24

# Порт для прослушивания
ListenPort = 51820

# Приватный ключ сервера (ЗАМЕНИТЬ!)
PrivateKey = SLATE_AX_WG_SERVER_PRIVATE_KEY_CHANGE_ME

# MTU для оптимизации (стандартный Ethernet 1500 - WireGuard overhead 80)
MTU = 1420

# Firewall и routing правила
# Разрешаем форвардинг из wg0 в домашнюю сеть
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostUp = iptables -A FORWARD -o wg0 -j ACCEPT
PostUp = iptables -t nat -A POSTROUTING -s 10.0.200.0/24 -o br-lan -j MASQUERADE

# Разрешаем доступ к LXC через OPNsense
PostUp = ip route add 10.0.30.0/24 via 192.168.10.1 dev br-lan
PostUp = ip route add 10.0.99.0/24 via 192.168.10.1 dev br-lan

PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
PostDown = iptables -D FORWARD -o wg0 -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -s 10.0.200.0/24 -o br-lan -j MASQUERADE
PostDown = ip route del 10.0.30.0/24 via 192.168.10.1 dev br-lan
PostDown = ip route del 10.0.99.0/24 via 192.168.10.1 dev br-lan

# ============================================================
# PEERS - VPN клиенты
# ============================================================

# Peer 1: Slate AX в Travel Mode (сам роутер в поездке)
[Peer]
# Публичный ключ Slate AX в Travel mode
PublicKey = SLATE_AX_TRAVEL_MODE_PUBLIC_KEY_CHANGE_ME

# Разрешенные IP адреса клиента
AllowedIPs = 10.0.200.10/32

# Keepalive для NAT traversal (важно для Hotel WiFi)
PersistentKeepalive = 25

# Peer 2: Android Phone (мобильный телефон)
[Peer]
PublicKey = ANDROID_PHONE_PUBLIC_KEY_CHANGE_ME
AllowedIPs = 10.0.200.20/32
PersistentKeepalive = 25

# Peer 3: Laptop (ноутбук для работы)
[Peer]
PublicKey = LAPTOP_PUBLIC_KEY_CHANGE_ME
AllowedIPs = 10.0.200.30/32
PersistentKeepalive = 25

# Peer 4: iPad/Tablet
[Peer]
PublicKey = IPAD_PUBLIC_KEY_CHANGE_ME
AllowedIPs = 10.0.200.40/32
PersistentKeepalive = 25

# Peer 5: Desktop PC (запасной доступ)
#[Peer]
#PublicKey = DESKTOP_PUBLIC_KEY_CHANGE_ME
#AllowedIPs = 10.0.200.50/32
#PersistentKeepalive = 25

# ============================================================
# ИНСТРУКЦИЯ ПО НАСТРОЙКЕ
# ============================================================
#
# 1. Генерация ключей на Slate AX:
#    ssh root@192.168.20.1
#    wg genkey | tee /etc/wireguard/server_privatekey | wg pubkey > /etc/wireguard/server_publickey
#
# 2. Замените SLATE_AX_WG_SERVER_PRIVATE_KEY_CHANGE_ME на содержимое:
#    cat /etc/wireguard/server_privatekey
#
# 3. Для каждого клиента сгенерируйте пару ключей:
#    wg genkey | tee client_privatekey | wg pubkey > client_publickey
#
# 4. Замените PUBLIC_KEY_CHANGE_ME на публичные ключи клиентов
#
# 5. Скопируйте этот файл на Slate AX:
#    scp wireguard-server-home.conf root@192.168.20.1:/etc/wireguard/wg0.conf
#
# 6. Запустите WireGuard:
#    ssh root@192.168.20.1
#    wg-quick up wg0
#    systemctl enable wg-quick@wg0
#
# 7. Проверьте статус:
#    wg show wg0
#
# 8. Настройте Port Forward на OPNsense:
#    WAN → 192.168.10.2:51820 (UDP)
#
# ============================================================
# КЛИЕНТСКАЯ КОНФИГУРАЦИЯ (пример для Android)
# ============================================================
#
# [Interface]
# PrivateKey = ANDROID_PHONE_PRIVATE_KEY
# Address = 10.0.200.20/32
# DNS = 192.168.20.1
#
# [Peer]
# PublicKey = SLATE_AX_WG_SERVER_PUBLIC_KEY
# Endpoint = your-home-ddns.com:51820
# AllowedIPs = 192.168.20.0/24, 10.0.30.0/24, 10.0.99.0/24
# PersistentKeepalive = 25
#
# ============================================================
# ДОСТУП К СЕРВИСАМ ИЗ VPN
# ============================================================
#
# После подключения к VPN доступны:
# - Домашняя сеть: 192.168.20.0/24
# - LXC сервисы: 10.0.30.0/24
#   - PostgreSQL: 10.0.30.10:5432
#   - Nextcloud: 10.0.30.30:443
#   - Grafana: 10.0.30.60:3000
# - Management:
#   - Proxmox: 10.0.99.1:8006
#   - OPNsense: 10.0.99.10:443
# - AdGuard Home: 192.168.20.1:3000
# - GL.iNet UI: 192.168.20.1
#
# ============================================================
