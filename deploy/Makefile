# =============================================================================
# Home Lab Infrastructure Deployment Makefile
# =============================================================================
#
# Usage:
#   make help          - Show available commands
#   make all           - Validate, generate, and show plans
#   make deploy-all    - Full deployment (network â†’ compute â†’ services)
#
# Prerequisites:
#   - Python 3.8+
#   - Terraform 1.5+
#   - Ansible 2.14+
#   - Bootstrap completed (see: make bootstrap-info)
#
# =============================================================================

.PHONY: all help validate generate plan apply deploy-all clean
.PHONY: plan-mikrotik plan-proxmox apply-mikrotik apply-proxmox
.PHONY: configure test bootstrap-info

# Directories (relative to deploy/)
ROOT_DIR := $(shell cd .. && pwd)
TOPOLOGY_DIR := $(ROOT_DIR)
TOPOLOGY_TOOLS_DIR := $(ROOT_DIR)/topology-tools
GENERATED_DIR := $(ROOT_DIR)/generated
ANSIBLE_DIR := $(ROOT_DIR)/ansible

# Colors
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
NC := \033[0m  # No Color

# =============================================================================
# Main Targets
# =============================================================================

all: validate generate plan
	@echo "$(GREEN)âœ“ All checks passed. Ready for deployment.$(NC)"
	@echo "  Run 'make deploy-all' to deploy, or apply individually:"
	@echo "  - make apply-mikrotik  (network first)"
	@echo "  - make apply-proxmox   (compute second)"
	@echo "  - make configure       (services last)"

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  Home Lab Infrastructure Deployment                              â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘  Validation & Generation:                                        â•‘"
	@echo "â•‘    make validate       - Validate topology YAML                  â•‘"
	@echo "â•‘    make generate       - Generate all configs from topology      â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Planning (Dry Run):                                             â•‘"
	@echo "â•‘    make plan           - Show all Terraform plans                â•‘"
	@echo "â•‘    make plan-mikrotik  - Show MikroTik changes                   â•‘"
	@echo "â•‘    make plan-proxmox   - Show Proxmox changes                    â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Deployment:                                                     â•‘"
	@echo "â•‘    make apply-mikrotik - Apply MikroTik configuration            â•‘"
	@echo "â•‘    make apply-proxmox  - Apply Proxmox configuration             â•‘"
	@echo "â•‘    make configure      - Run Ansible playbooks                   â•‘"
	@echo "â•‘    make deploy-all     - Full deployment (all phases)            â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  Utilities:                                                      â•‘"
	@echo "â•‘    make test           - Verify deployment health                â•‘"
	@echo "â•‘    make clean          - Clean generated files                   â•‘"
	@echo "â•‘    make bootstrap-info - Show bootstrap instructions             â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# =============================================================================
# Validation & Generation
# =============================================================================

validate:
	@echo "$(YELLOW)ğŸ“‹ Validating topology...$(NC)"
	cd $(TOPOLOGY_DIR) && python3 topology-tools/validate-topology.py
	@echo "$(GREEN)âœ“ Topology validation passed$(NC)"

generate: generate-terraform generate-mikrotik generate-ansible generate-docs
	@echo "$(GREEN)âœ“ All configurations generated$(NC)"

generate-terraform:
	@echo "$(YELLOW)ğŸ“ Generating Terraform (Proxmox)...$(NC)"
	cd $(TOPOLOGY_DIR) && python3 topology-tools/generate-terraform-proxmox.py

generate-mikrotik:
	@echo "$(YELLOW)ğŸ“ Generating Terraform (MikroTik)...$(NC)"
	cd $(TOPOLOGY_DIR) && python3 topology-tools/generate-terraform-mikrotik.py

generate-ansible:
	@echo "$(YELLOW)ğŸ“ Generating Ansible inventory...$(NC)"
	cd $(TOPOLOGY_DIR) && python3 topology-tools/generate-ansible-inventory.py

generate-docs:
	@echo "$(YELLOW)ğŸ“ Generating documentation...$(NC)"
	cd $(TOPOLOGY_DIR) && python3 topology-tools/generate-docs.py || true

# =============================================================================
# Terraform Planning
# =============================================================================

plan: plan-mikrotik plan-proxmox
	@echo "$(GREEN)âœ“ All plans generated$(NC)"

plan-mikrotik:
	@echo "$(YELLOW)ğŸ” Planning MikroTik changes...$(NC)"
	@if [ -f $(GENERATED_DIR)/terraform-mikrotik/terraform.tfvars ]; then \
		cd $(GENERATED_DIR)/terraform-mikrotik && terraform init -upgrade && terraform plan; \
	else \
		echo "$(RED)âš ï¸  terraform.tfvars not found. Copy terraform.tfvars.example first.$(NC)"; \
		exit 1; \
	fi

plan-proxmox:
	@echo "$(YELLOW)ğŸ” Planning Proxmox changes...$(NC)"
	@if [ -f $(GENERATED_DIR)/terraform/terraform.tfvars ]; then \
		cd $(GENERATED_DIR)/terraform && terraform init -upgrade && terraform plan; \
	else \
		echo "$(RED)âš ï¸  terraform.tfvars not found. Copy terraform.tfvars.example first.$(NC)"; \
		exit 1; \
	fi

# =============================================================================
# Terraform Apply
# =============================================================================

apply-mikrotik:
	@echo "$(YELLOW)ğŸš€ Applying MikroTik configuration...$(NC)"
	@echo "$(RED)âš ï¸  This will modify your MikroTik router. Ensure you have console access!$(NC)"
	@read -p "Continue? [y/N] " confirm && [ "$$confirm" = "y" ] || exit 1
	./phases/01-network.sh

apply-proxmox:
	@echo "$(YELLOW)ğŸš€ Applying Proxmox configuration...$(NC)"
	./phases/02-compute.sh

# =============================================================================
# Ansible Configuration
# =============================================================================

configure:
	@echo "$(YELLOW)âš™ï¸  Running Ansible playbooks...$(NC)"
	./phases/03-services.sh

# =============================================================================
# Full Deployment
# =============================================================================

deploy-all: validate generate
	@echo "$(YELLOW)ğŸš€ Starting full deployment...$(NC)"
	@echo ""
	@echo "Deployment order:"
	@echo "  1. Network (MikroTik)"
	@echo "  2. Compute (Proxmox)"
	@echo "  3. Services (Ansible)"
	@echo "  4. Verification"
	@echo ""
	@read -p "Continue with full deployment? [y/N] " confirm && [ "$$confirm" = "y" ] || exit 1
	./phases/01-network.sh
	./phases/02-compute.sh
	./phases/03-services.sh
	./phases/04-verify.sh
	@echo "$(GREEN)âœ… Full deployment completed!$(NC)"

# =============================================================================
# Verification
# =============================================================================

test:
	@echo "$(YELLOW)ğŸ§ª Running deployment verification...$(NC)"
	./phases/04-verify.sh

# =============================================================================
# Utilities
# =============================================================================

clean:
	@echo "$(YELLOW)ğŸ§¹ Cleaning generated files...$(NC)"
	rm -rf $(GENERATED_DIR)/terraform-mikrotik/*.tf
	rm -rf $(GENERATED_DIR)/terraform-mikrotik/.terraform
	rm -f $(GENERATED_DIR)/terraform-mikrotik/terraform.tfstate*
	@echo "$(GREEN)âœ“ Generated MikroTik files cleaned$(NC)"
	@echo "$(YELLOW)Note: Proxmox terraform state preserved. Use 'make clean-all' to remove.$(NC)"

clean-all: clean
	rm -rf $(GENERATED_DIR)/terraform/*.tf
	rm -rf $(GENERATED_DIR)/terraform/.terraform
	rm -f $(GENERATED_DIR)/terraform/terraform.tfstate*
	@echo "$(GREEN)âœ“ All generated files cleaned$(NC)"

bootstrap-info:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  Bootstrap Instructions                                          â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  1. MikroTik Bootstrap:                                          â•‘"
	@echo "â•‘     - Connect via WinBox to 192.168.88.1                         â•‘"
	@echo "â•‘     - Import: bootstrap/mikrotik/bootstrap.rsc                   â•‘"
	@echo "â•‘     - Or run commands manually (see README)                      â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  2. Proxmox Bootstrap:                                           â•‘"
	@echo "â•‘     - Use: manual-scripts/bare-metal/create-uefi-autoinstall-proxmox-usb.sh     â•‘"
	@echo "â•‘     - Boot from USB, auto-install completes                      â•‘"
	@echo "â•‘     - Run post-install scripts                                   â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  3. Orange Pi 5 Bootstrap:                                       â•‘"
	@echo "â•‘     - Flash Armbian to NVMe with cloud-init                      â•‘"
	@echo "â•‘     - Configure network via cloud-init user-data                 â•‘"
	@echo "â•‘                                                                  â•‘"
	@echo "â•‘  After bootstrap, run: make deploy-all                           â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# =============================================================================
# Init targets (first-time setup)
# =============================================================================

init-mikrotik:
	@echo "$(YELLOW)Initializing MikroTik Terraform...$(NC)"
	cd $(GENERATED_DIR)/terraform-mikrotik && terraform init -upgrade

init-proxmox:
	@echo "$(YELLOW)Initializing Proxmox Terraform...$(NC)"
	cd $(GENERATED_DIR)/terraform && terraform init -upgrade

init: init-mikrotik init-proxmox
	@echo "$(GREEN)âœ“ All Terraform providers initialized$(NC)"

