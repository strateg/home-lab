# =============================================================================
# MikroTik Firewall Configuration
# Generated from topology v{{ topology_version }}
# DO NOT EDIT MANUALLY - Regenerate with: python3 topology-tools/generate-terraform-mikrotik.py
# =============================================================================

# -----------------------------------------------------------------------------
# Address Lists
# -----------------------------------------------------------------------------

{% for addr in firewall_address_lists %}
resource "routeros_ip_firewall_addr_list" "{{ addr.resource_name }}" {
  list    = "{{ addr.list }}"
  address = "{{ addr.address }}"
  comment = "{{ addr.comment }}"
}

{% endfor %}

# -----------------------------------------------------------------------------
# Firewall Filter Rules - Input Chain
# -----------------------------------------------------------------------------

resource "routeros_ip_firewall_filter" "input_established" {
  chain            = "input"
  action           = "accept"
  connection_state = "established,related"
  comment          = "Accept established/related connections"
}

resource "routeros_ip_firewall_filter" "input_icmp" {
  chain    = "input"
  action   = "accept"
  protocol = "icmp"
  comment  = "Accept ICMP (ping)"
}

resource "routeros_ip_firewall_filter" "input_ssh_lan" {
  chain            = "input"
  action           = "accept"
  protocol         = "tcp"
  dst_port         = "22"
  src_address_list = "{{ lan_admin_list_name }}"
  comment          = "Accept SSH from LAN"
}

resource "routeros_ip_firewall_filter" "input_winbox" {
  chain            = "input"
  action           = "accept"
  protocol         = "tcp"
  dst_port         = "8291"
  src_address_list = "{{ lan_admin_list_name }}"
  comment          = "Accept Winbox from LAN"
}

resource "routeros_ip_firewall_filter" "input_api" {
  chain            = "input"
  action           = "accept"
  protocol         = "tcp"
  dst_port         = "8443"
  src_address_list = "{{ management_list_name }}"
  comment          = "Accept REST API from management network"
}

resource "routeros_ip_firewall_filter" "input_dns" {
  chain    = "input"
  action   = "accept"
  protocol = "udp"
  dst_port = "53"
  comment  = "Accept DNS queries"
}

resource "routeros_ip_firewall_filter" "input_dhcp" {
  chain    = "input"
  action   = "accept"
  protocol = "udp"
  dst_port = "67"
  comment  = "Accept DHCP requests"
}

resource "routeros_ip_firewall_filter" "input_wireguard" {
  chain        = "input"
  action       = "accept"
  protocol     = "udp"
  dst_port     = "51820"
  in_interface = "{{ wan_interface_name }}"
  comment      = "Accept WireGuard from WAN"
}

resource "routeros_ip_firewall_filter" "input_drop_wan" {
  chain        = "input"
  action       = "drop"
  in_interface = "{{ wan_interface_name }}"
  comment      = "Drop all other input from WAN"
  log          = true
  log_prefix   = "DROP_INPUT_WAN:"
}

# -----------------------------------------------------------------------------
# Firewall Filter Rules - Forward Chain
# -----------------------------------------------------------------------------

resource "routeros_ip_firewall_filter" "forward_established" {
  chain            = "forward"
  action           = "accept"
  connection_state = "established,related"
  comment          = "Accept established/related forward"
}

resource "routeros_ip_firewall_filter" "forward_invalid" {
  chain            = "forward"
  action           = "drop"
  connection_state = "invalid"
  comment          = "Drop invalid connections"
}

{% for policy in firewall_policies %}
{% if policy.chain == 'forward' %}
resource "routeros_ip_firewall_filter" "{{ policy.resource_name }}" {
  chain            = "forward"
  action           = "{{ policy.action }}"
  {% if policy.source_address_list %}
  src_address_list = "{{ policy.source_address_list }}"
  {% endif %}
  {% if policy.destination_address_list %}
  dst_address_list = "{{ policy.destination_address_list }}"
  {% endif %}
  {% if policy.connection_state_csv %}
  connection_state = "{{ policy.connection_state_csv }}"
  {% endif %}
  {% if policy.protocol %}
  protocol         = "{{ policy.protocol }}"
  {% endif %}
  {% if policy.ports_csv %}
  dst_port         = "{{ policy.ports_csv }}"
  {% endif %}
  comment          = "{{ policy.name }}: {{ policy.description }}"
}

{% endif %}
{% endfor %}
# Default drop for forward
resource "routeros_ip_firewall_filter" "forward_drop_default" {
  chain      = "forward"
  action     = "drop"
  comment    = "Default drop all forward"
  log        = true
  log_prefix = "DROP_FORWARD:"
}

# -----------------------------------------------------------------------------
# NAT Rules
# -----------------------------------------------------------------------------

resource "routeros_ip_firewall_nat" "masquerade_wan" {
  chain         = "srcnat"
  action        = "masquerade"
  out_interface = "{{ wan_interface_name }}"
  comment       = "Masquerade outgoing traffic on WAN"
}

resource "routeros_ip_firewall_nat" "masquerade_lte" {
  chain         = "srcnat"
  action        = "masquerade"
  out_interface = "{{ lte_interface_name }}"
  comment       = "Masquerade outgoing traffic on LTE failover"
}

# DNS redirect to AdGuard container
resource "routeros_ip_firewall_nat" "dns_redirect" {
  chain        = "dstnat"
  action       = "dst-nat"
  protocol     = "udp"
  dst_port     = "53"
  to_addresses = "192.168.88.1"
  to_ports     = "53"
  comment      = "Redirect DNS to AdGuard"
}
