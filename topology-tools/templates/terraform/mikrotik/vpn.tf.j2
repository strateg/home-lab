# =============================================================================
# MikroTik VPN Configuration (WireGuard)
# Generated from topology v{{ topology_version }}
# DO NOT EDIT MANUALLY - Regenerate with: python3 topology-tools/generate-terraform-mikrotik.py
# =============================================================================

# -----------------------------------------------------------------------------
# WireGuard Interface
# -----------------------------------------------------------------------------

resource "routeros_interface_wireguard" "wg_home" {
  name        = "wireguard1"
  listen_port = {{ wireguard.port | default(51820) }}
  private_key = var.wireguard_private_key
  mtu         = 1420
  comment     = "WireGuard VPN - Home Access"
}

# -----------------------------------------------------------------------------
# WireGuard IP Address
# -----------------------------------------------------------------------------

resource "routeros_ip_address" "wg_home_address" {
  address   = "{{ wireguard.server_ip | default('10.0.200.1') }}/24"
  interface = routeros_interface_wireguard.wg_home.name
  comment   = "WireGuard VPN server address"

  depends_on = [routeros_interface_wireguard.wg_home]
}

# -----------------------------------------------------------------------------
# WireGuard Peers
# -----------------------------------------------------------------------------

# WireGuard peers are managed via the wireguard_peers variable
# Add peers in terraform.tfvars:
#   wireguard_peers = [
#     { name = "phone", public_key = "...", allowed_ips = ["10.0.200.10/32"] },
#     { name = "laptop", public_key = "...", allowed_ips = ["10.0.200.11/32"] }
#   ]

resource "routeros_interface_wireguard_peer" "peers" {
  for_each = { for peer in var.wireguard_peers : peer.name => peer }

  interface            = routeros_interface_wireguard.wg_home.name
  public_key           = each.value.public_key
  allowed_address      = each.value.allowed_ips
  persistent_keepalive = lookup(each.value, "keepalive", "25s")
  comment              = lookup(each.value, "comment", each.key)

  depends_on = [routeros_interface_wireguard.wg_home]
}

# -----------------------------------------------------------------------------
# WireGuard Firewall Rules
# -----------------------------------------------------------------------------

resource "routeros_ip_firewall_filter" "wg_input" {
  chain        = "input"
  action       = "accept"
  protocol     = "udp"
  dst_port     = "{{ wireguard.port | default(51820) }}"
  in_interface = "{{ wan_interface_name }}"
  comment      = "Accept WireGuard on WAN"
}

resource "routeros_ip_firewall_filter" "wg_forward_in" {
  chain        = "forward"
  action       = "accept"
  in_interface = routeros_interface_wireguard.wg_home.name
  comment      = "Accept traffic from WireGuard"

  depends_on = [routeros_interface_wireguard.wg_home]
}

resource "routeros_ip_firewall_filter" "wg_forward_out" {
  chain         = "forward"
  action        = "accept"
  out_interface = routeros_interface_wireguard.wg_home.name
  comment       = "Accept traffic to WireGuard"

  depends_on = [routeros_interface_wireguard.wg_home]
}

# -----------------------------------------------------------------------------
# WireGuard NAT (if needed for VPN clients to access internet)
# -----------------------------------------------------------------------------

resource "routeros_ip_firewall_nat" "wg_masquerade" {
  chain         = "srcnat"
  action        = "masquerade"
  src_address   = "{{ wireguard.network | default('10.0.200.0/24') }}"
  out_interface = "{{ wan_interface_name }}"
  comment       = "Masquerade WireGuard clients to WAN"
}
