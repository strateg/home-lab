# L7 Operations
# Part of Home Lab Topology v4.0.0
# Workflows, runbooks, docs, backups, automation
# Edit this file then regenerate: python3 topology-tools/regenerate-all.py

workflows:
  fresh_install:
    name: Fresh Proxmox Installation
    description: Complete installation from bare metal to running infrastructure
    steps:
    - step: 1
      name: Create bootable USB
      script: manual-scripts/bare-metal/run-create-usb.sh
      alternative: manual-scripts/bare-metal/create-uefi-autoinstall-proxmox-usb.sh
      duration_min: 5
    - step: 2
      name: Boot and auto-install Proxmox
      manual: true
      duration_min: 15
      notes: 'Insert USB, F12 boot menu, select UEFI: USB, wait for auto-install'
    - step: 3
      name: Run post-install scripts
      script: manual-scripts/bare-metal/post-install/01-install-terraform.sh
      duration_min: 10
    - step: 4
      name: Generate Terraform from topology
      script: topology-tools/generate-terraform-proxmox.py
      duration_min: 1
    - step: 5
      name: Apply Terraform configuration
      command: cd terraform && terraform apply
      duration_min: 5
    - step: 6
      name: Generate Ansible inventory from topology
      script: topology-tools/generate-ansible-inventory.py
      duration_min: 1
    - step: 7
      name: Run Ansible playbooks
      command: cd ansible && ansible-playbook -i inventory/production/hosts.yml site.yml
      duration_min: 20
  update_topology:
    name: Update Infrastructure Topology
    description: Modify topology and regenerate all configs
    steps:
    - step: 1
      name: Edit topology.yaml
      manual: true
    - step: 2
      name: Validate topology
      script: topology-tools/validate-topology.py
    - step: 3
      name: Regenerate Terraform
      script: topology-tools/generate-terraform-proxmox.py
    - step: 4
      name: Regenerate Ansible inventory
      script: topology-tools/generate-ansible-inventory.py
    - step: 5
      name: Regenerate documentation
      script: topology-tools/generate-docs.py
    - step: 6
      name: Plan Terraform changes
      command: cd terraform && terraform plan
    - step: 7
      name: Apply changes if approved
      command: cd terraform && terraform apply
runbooks: []
power_resilience: !include L7-operations/power/_index.yaml
documentation:
  network_diagram:
    format: mermaid
    output: docs/network-diagram.md
    auto_generate: true
    include:
    - L1_foundation
    - L2_network.networks
    - L2_network.trust_zones
  trust_zone_diagram:
    format: mermaid
    output: docs/trust-zones.md
    auto_generate: true
    style: security-focused
  ip_allocation:
    format: markdown-table
    output: docs/ip-allocation.md
    auto_generate: true
  service_inventory:
    format: markdown
    output: docs/services.md
    auto_generate: true
    include_dependencies: true
  device_inventory:
    format: markdown
    output: docs/devices.md
    auto_generate: true
notes:
- All IPs are referenced by ID, not hardcoded - enables dynamic generation
- Trust zones enable automated firewall rule generation
- Physical/logical separation makes structure clear
- Services reference compute resources by ID for flexibility
- Single environment (production) - multi-env can be added if needed
- 'Validate topology with: python3 topology-tools/validate-topology.py'
- 'Regenerate everything with: python3 topology-tools/regenerate-all.py'
ansible:
  group_vars:
    all:
      ansible_user: root
      ansible_python_interpreter: /usr/bin/python3
      ansible_ssh_common_args: -o StrictHostKeyChecking=no
      timezone: UTC
      locale: en_US.UTF-8
      common_packages:
      - vim
      - git
      - curl
      - wget
      - htop
      - tmux
      - net-tools
      - dnsutils
      - python3
      - python3-pip
      dns_servers:
      - 192.168.88.1
      - 1.1.1.1
      search_domains:
      - home.local
      ntp_servers:
      - pool.ntp.org
      - time.cloudflare.com
    lxc_containers:
      cloud_init_enabled: true
      ssh_permit_root_login: prohibit-password
      ssh_password_authentication: false
      monitoring_enabled: true
      log_retention_days: 30
    databases:
      backup_enabled: true
      backup_schedule: 0 2 * * *
      monitoring_queries: true
      max_connections: 50
    web_applications:
      ssl_enabled: true
      auto_renew_certs: true
      rate_limiting: true
  host_vars:
    postgresql-db:
      postgresql_version: '15'
      postgresql_max_connections: 50
      postgresql_shared_buffers: 256MB
      postgresql_effective_cache_size: 768MB
      postgresql_work_mem: 4MB
      postgresql_maintenance_work_mem: 64MB
      postgresql_databases:
      - name: homelab
        owner: app
      postgresql_users:
      - name: app
        password: '{{ vault_postgresql_app_password }}'
        privileges: ALL
      postgresql_hba_entries:
      - type: host
        database: homelab
        user: app
        address: 10.0.30.0/24
        method: scram-sha-256
    redis-cache:
      redis_version: '7'
      redis_port: 6379
      redis_bind: 10.0.30.20
      redis_maxmemory: 512mb
      redis_maxmemory_policy: allkeys-lru
      redis_save:
      - 900 1
      - 300 10
    nextcloud:
      nextcloud_version: '28'
      nextcloud_domain: nextcloud.home.local
      nextcloud_admin_user: admin
      nextcloud_admin_password: '{{ vault_nextcloud_admin_password }}'
      nextcloud_db_type: pgsql
      nextcloud_db_host: 10.0.30.10
      nextcloud_db_name: nextcloud
      nextcloud_db_user: nextcloud
      nextcloud_db_password: '{{ vault_nextcloud_db_password }}'
      nextcloud_redis_host: 10.0.30.20
      nextcloud_redis_port: 6379
      nextcloud_trusted_domains:
      - nextcloud.home.local
      - 10.0.30.50
      nextcloud_apps:
      - files
      - files_sharing
      - files_versions
      - files_trashbin
      - encryption
      - user_ldap
  playbooks:
    site:
      file: site.yml
      description: Run all playbooks in order
      order:
      - common.yml
      - databases.yml
      - cache.yml
      - web_applications.yml
    postgresql:
      file: postgresql.yml
      description: Deploy PostgreSQL database
      hosts: databases
      roles:
      - common
      - postgresql
    redis:
      file: redis.yml
      description: Deploy Redis cache
      hosts: cache_servers
      roles:
      - common
      - redis
    nextcloud:
      file: nextcloud.yml
      description: Deploy Nextcloud application
      hosts: web_applications
      roles:
      - common
      - nginx
      - php-fpm
      - nextcloud
  vault_vars:
  - vault_postgresql_app_password
  - vault_nextcloud_admin_password
  - vault_nextcloud_db_password
  - vault_proxmox_api_token
  config:
    inventory: inventory/production/hosts.yml
    remote_user: root
    host_key_checking: false
    retry_files_enabled: false
    gather_facts: true
    fact_caching: jsonfile
    fact_caching_connection: /tmp/ansible_facts
    fact_caching_timeout: 86400
backup:
  strategy:
    rule: 3-2-1
    copies: 3
    media:
    - id: media-proxmox-ssd
      type: ssd
      device_ref: gamayun
      path: /dev/sda
      role: primary
    - id: media-proxmox-hdd
      type: hdd
      device_ref: gamayun
      path: /mnt/hdd
      role: local-backup
    - id: media-cloud
      type: cloud
      provider: backblaze-b2
      role: offsite
      encrypted: true
  policies:
  - id: backup-mikrotik-config
    name: MikroTik Config Backup
    description: Export RouterOS configuration to Git repository
    targets:
    - device_ref: mikrotik-chateau
      data_asset_ref: data-mikrotik-config
    type: config-export
    schedule: 0 4 * * *
    method: routeros-export
    export_format: rsc
    destination:
      type: git
      repository: /home/dmpr/workspaces/projects/home-lab/backups/mikrotik
      branch: main
      commit_message: Automated MikroTik config backup - {{ date }}
    retention:
      keep_commits: 90
    verification:
      syntax_check: true
    notification:
      on_success: false
      on_failure: true
      channels:
      - email
    security_policy_ref: sec-baseline
  - id: backup-orangepi5-data
    name: Orange Pi 5 Data Backup
    description: Backup Docker volumes and NVMe data to Proxmox HDD
    targets:
    - device_ref: orangepi5
      data_asset_ref: data-nextcloud
    - device_ref: orangepi5
      data_asset_ref: data-jellyfin-config
    - device_ref: orangepi5
      data_asset_ref: data-grafana
    - device_ref: orangepi5
      data_asset_ref: data-prometheus
    - device_ref: orangepi5
      data_asset_ref: data-homeassistant
    type: rsync
    schedule: 0 3 * * *
    source_paths:
    - /mnt/nvme/nextcloud
    - /mnt/nvme/jellyfin/config
    - /mnt/nvme/grafana
    - /mnt/nvme/prometheus
    - /mnt/nvme/homeassistant
    destination:
      type: rsync
      target: root@192.168.88.2:/mnt/hdd/backups/orangepi5
      ssh_key: /root/.ssh/id_ed25519
    options:
      incremental: true
      compress: true
      delete_old: false
      bandwidth_limit_kbps: 50000
    retention:
      keep_daily: 7
      keep_weekly: 4
    notification:
      on_success: false
      on_failure: true
      channels:
      - email
    security_policy_ref: sec-baseline
  - id: backup-hourly-postgresql
    name: Hourly PostgreSQL Backups
    description: Hourly pg_dump for critical database
    targets:
    - lxc_ref: lxc-postgresql
      data_asset_ref: data-postgresql-db
    type: pg_dump
    schedule: 0 * * * *
    databases:
    - nextcloud
    - homelab
    destination:
      storage_ref: storage-hdd
      path: /mnt/hdd/backups/postgresql
    compression: zstd
    retention:
      keep_last: 24
      keep_daily: 7
    notification:
      on_success: false
      on_failure: true
      channels:
      - email
    security_policy_ref: sec-baseline
  - id: backup-daily-postgresql-lxc
    name: Daily PostgreSQL LXC Snapshot
    description: Full LXC snapshot for disaster recovery
    targets:
    - lxc_ref: lxc-postgresql
      data_asset_ref: data-postgresql-db
    type: vzdump
    schedule: 0 2 * * *
    storage_ref: storage-hdd
    mode: snapshot
    compression: zstd
    retention:
      keep_last: 3
      keep_daily: 7
      keep_weekly: 4
    notification:
      on_success: false
      on_failure: true
      channels:
      - email
    security_policy_ref: sec-baseline
  - id: backup-daily-redis
    name: Daily Redis Backup
    description: Daily backup of Redis LXC
    targets:
    - lxc_ref: lxc-redis
      data_asset_ref: data-redis-db
    type: vzdump
    schedule: 0 2 * * *
    storage_ref: storage-hdd
    mode: snapshot
    compression: zstd
    retention:
      keep_last: 3
      keep_daily: 7
    notification:
      on_success: false
      on_failure: true
      channels:
      - email
    security_policy_ref: sec-baseline
  - id: backup-weekly-full
    name: Weekly Full Infrastructure Backup
    description: Complete weekly backup of all LXC containers
    targets:
    - lxc_ref: lxc-postgresql
      data_asset_ref: data-postgresql-db
    - lxc_ref: lxc-redis
      data_asset_ref: data-redis-db
    type: vzdump
    schedule: 0 1 * * 0
    storage_ref: storage-hdd
    mode: snapshot
    compression: zstd
    retention:
      keep_last: 4
      keep_weekly: 8
      keep_monthly: 6
    notification:
      on_success: true
      on_failure: true
      channels:
      - email
    security_policy_ref: sec-baseline
  - id: backup-offsite-weekly
    name: Weekly Offsite Backup
    description: Critical data to cloud storage (encrypted)
    targets:
    - data_asset_ref: data-postgresql-dumps
    - data_asset_ref: data-mikrotik-config
    - data_asset_ref: data-nextcloud
    type: rclone
    schedule: 0 5 * * 0
    source_paths:
    - /mnt/hdd/backups/postgresql
    - /mnt/hdd/backups/mikrotik
    - /mnt/hdd/backups/orangepi5/nextcloud
    destination:
      type: cloud
      provider: backblaze-b2
      bucket: homelab-backups
      path: /weekly
    encryption:
      enabled: true
      method: rclone-crypt
      password_file: /root/.config/rclone/crypt-password
    retention:
      keep_weekly: 8
      keep_monthly: 6
    notification:
      on_success: true
      on_failure: true
      channels:
      - email
    security_policy_ref: sec-baseline
  verification:
    enabled: true
    schedule: 0 6 * * 1
    checks:
    - type: integrity
      description: Verify backup file integrity
    - type: restore_test
      description: Test restore to temporary location
      enabled: false
      frequency: monthly
    notification:
      on_success: false
      on_failure: true
      channels:
      - email
  storage_monitoring:
    enabled: true
    locations:
    - path: /mnt/hdd/backups
      warning_percent: 70
      critical_percent: 85
    - path: cloud:homelab-backups
      warning_gb: 50
      critical_gb: 100
    notification:
      channels:
      - email
security:
  ssh_keys:
  - id: ssh-admin-primary
    name: Admin Primary Key
    type: ed25519
    public_key: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIExampleKeyData admin@workstation
    purpose: Primary administration key
    authorized_for:
    - device_ref: gamayun
    - lxc_ref: lxc-postgresql
    - lxc_ref: lxc-redis
    created: '2025-10-06'
    expires: null
  - id: ssh-automation
    name: Automation Key
    type: ed25519
    public_key: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIExampleKeyData ansible@controller
    purpose: Ansible automation
    authorized_for:
    - device_ref: gamayun
    created: '2025-10-06'
    expires: null
  - id: ssh-backup
    name: Backup Key
    type: ed25519
    public_key: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIExampleKeyData backup@backup-server
    purpose: Backup system access (read-only)
    authorized_for:
    - device_ref: gamayun
    permissions: read-only
    created: '2025-10-10'
    expires: '2026-10-10'
  ssh_key_deployment:
    method: cloud-init
    update_authorized_keys: true
    remove_old_keys: false
    backup_before_update: true
  proxmox:
    root_password_hash: $6$Wx8sYKmgnwHk4BgS$eGr047.zvpBPesQF.sQ13IFcLdPSaIhqJ8eteA5Y0LSwq4Fp2vurgSN9LmWLjvxBPKJCRpt57l.vC9izxPQvn0

