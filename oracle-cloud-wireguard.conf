# Oracle Cloud WireGuard Configuration
# File: /etc/wireguard/wg0.conf
#
# Prerequisites on Oracle Cloud VM:
# 1. Ubuntu 22.04 LTS (Always Free tier: 4 OCPU ARM, 24GB RAM)
# 2. Install: apt update && apt install wireguard-tools
# 3. Enable IP forwarding: echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
# 4. Apply: sysctl -p

[Interface]
# Oracle Cloud server
Address = 10.1.0.1/24
ListenPort = 51820
PrivateKey = ORACLE_SERVER_PRIVATE_KEY_HERE

# Enable packet forwarding
PostUp = iptables -A FORWARD -i %i -j ACCEPT
PostUp = iptables -A FORWARD -o %i -j ACCEPT
PostUp = iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT
PostDown = iptables -D FORWARD -o %i -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE

# ============================================================
# Peer 1: OpenWRT Travel Router
# ============================================================
[Peer]
# OpenWRT in travel mode
PublicKey = OPENWRT_PUBLIC_KEY_HERE
AllowedIPs = 10.1.200.10/32
PersistentKeepalive = 25

# ============================================================
# Peer 2: Home OPNsense (site-to-site VPN)
# ============================================================
[Peer]
# Home OPNsense server
PublicKey = OPNSENSE_PUBLIC_KEY_HERE
Endpoint = your-home-ddns.example.com:51821
AllowedIPs = 10.0.0.0/16, 192.168.10.0/24
PersistentKeepalive = 25

# ============================================================
# Oracle Cloud Firewall Rules (via iptables)
# ============================================================
# Add these rules to /etc/iptables/rules.v4

# Allow WireGuard port
# iptables -A INPUT -p udp --dport 51820 -j ACCEPT

# Allow forwarding between VPN peers
# iptables -A FORWARD -i wg0 -o wg0 -j ACCEPT

# Allow VPN to internet
# iptables -A FORWARD -i wg0 -o ens3 -j ACCEPT
# iptables -A FORWARD -i ens3 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT

# NAT for VPN traffic
# iptables -t nat -A POSTROUTING -s 10.1.0.0/16 -o ens3 -j MASQUERADE

# ============================================================
# Oracle Cloud Security List (OCI Console)
# ============================================================
# Navigate to: Networking → Virtual Cloud Networks → Your VCN → Security Lists
# Add Ingress Rule:
#   - Stateless: No
#   - Source Type: CIDR
#   - Source CIDR: 0.0.0.0/0
#   - IP Protocol: UDP
#   - Destination Port Range: 51820
#   - Description: WireGuard VPN

# ============================================================
# Routing for site-to-site (Home <-> Oracle)
# ============================================================
# On Oracle Cloud, add route to home networks via WireGuard tunnel
# ip route add 10.0.0.0/16 via 10.1.0.2 dev wg0
# ip route add 192.168.10.0/24 via 10.1.0.2 dev wg0

# Make persistent in /etc/network/interfaces or use systemd-networkd

# ============================================================
# Systemd service
# ============================================================
# Enable and start WireGuard:
# systemctl enable wg-quick@wg0
# systemctl start wg-quick@wg0

# Check status:
# wg show
# systemctl status wg-quick@wg0
