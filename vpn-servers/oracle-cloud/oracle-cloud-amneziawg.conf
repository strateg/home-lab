# AmneziaWG Server Configuration (Oracle Cloud)
# Обфусцированный WireGuard для обхода DPI в России
# Файл: /etc/amnezia/amneziawg/awg0.conf

[Interface]
Address = 10.8.2.1/24
ListenPort = 51821
PrivateKey = SERVER_PRIVATE_KEY_CHANGE_ME

# Обфускация параметры (специально для РФ DPI)
# Эти параметры делают трафик похожим на обычный UDP/HTTPS
Jc = 5          # Junk packet count - количество мусорных пакетов
Jmin = 50       # Junk packet min size - минимальный размер мусорного пакета (bytes)
Jmax = 1000     # Junk packet max size - максимальный размер мусорного пакета (bytes)
S1 = 30         # Init packet junk size - размер мусора в init пакете
S2 = 50         # Response packet junk size - размер мусора в response пакете
H1 = 1234567890 # Init packet magic header - магический заголовок init пакета
H2 = 9876543210 # Response packet magic header - магический заголовок response
H3 = 1122334455 # Underload packet magic header
H4 = 5544332211 # Transport packet magic header

# Firewall правила
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE

# Peer 1: GL-AX1800 Travel Router
[Peer]
PublicKey = GL_AX1800_PUBLIC_KEY_CHANGE_ME
PresharedKey = PRESHARED_KEY_CHANGE_ME
AllowedIPs = 10.8.2.2/32
PersistentKeepalive = 25

# Peer 2: Android Phone (опционально)
#[Peer]
#PublicKey = PHONE_PUBLIC_KEY_CHANGE_ME
#PresharedKey = PRESHARED_KEY_CHANGE_ME
#AllowedIPs = 10.8.2.3/32
#PersistentKeepalive = 25

# Peer 3: Laptop (опционально)
#[Peer]
#PublicKey = LAPTOP_PUBLIC_KEY_CHANGE_ME
#PresharedKey = PRESHARED_KEY_CHANGE_ME
#AllowedIPs = 10.8.2.4/32
#PersistentKeepalive = 25

# ============================================================
# ИНСТРУКЦИЯ ПО НАСТРОЙКЕ
# ============================================================

# 1. Установить AmneziaWG на Oracle Cloud:
#
# wget https://github.com/amnezia-vpn/amneziawg-linux-kernel-module/releases/latest/download/amneziawg-install.sh
# chmod +x amneziawg-install.sh
# sudo ./amneziawg-install.sh
#
# Или вручную:
# sudo add-apt-repository ppa:amnezia/ppa
# sudo apt update
# sudo apt install amneziawg amneziawg-tools

# 2. Создать ключи:
#
# cd /etc/amnezia/amneziawg/
# awg genkey | tee server_privatekey | awg pubkey > server_publickey
# awg genkey | tee client_privatekey | awg pubkey > client_publickey
# awg genpsk > preshared_key

# 3. Заменить ключи в этом файле:
#
# SERVER_PRIVATE_KEY_CHANGE_ME = содержимое server_privatekey
# GL_AX1800_PUBLIC_KEY_CHANGE_ME = содержимое client_publickey
# PRESHARED_KEY_CHANGE_ME = содержимое preshared_key

# 4. Скопировать конфиг:
#
# sudo cp oracle-cloud-amneziawg.conf /etc/amnezia/amneziawg/awg0.conf
# sudo chmod 600 /etc/amnezia/amneziawg/awg0.conf

# 5. Включить и запустить:
#
# sudo systemctl enable awg-quick@awg0
# sudo systemctl start awg-quick@awg0

# 6. Проверить статус:
#
# sudo awg show awg0
# sudo systemctl status awg-quick@awg0

# 7. Открыть порт в Oracle Cloud firewall:
#
# sudo iptables -I INPUT -p udp --dport 51821 -j ACCEPT
# sudo netfilter-persistent save
#
# В Oracle Cloud Console:
# Networking → Virtual Cloud Networks → Security Lists → Ingress Rules
# Add: UDP, Source 0.0.0.0/0, Destination Port 51821

# ============================================================
# ОТЛИЧИЯ ОТ ОБЫЧНОГО WIREGUARD
# ============================================================
#
# 1. Другой порт (51821 вместо 51820)
#    - Помогает избежать блокировки по известным портам
#
# 2. Другая подсеть (10.8.2.0/24 вместо 10.8.1.0/24)
#    - WireGuard и AmneziaWG могут работать параллельно
#
# 3. Обфускация параметры (Jc, Jmin, Jmax, S1, S2, H1-H4)
#    - Маскируют WireGuard трафик под обычный UDP
#    - DPI не может определить протокол
#
# 4. Команды awg вместо wg
#    - awg show / awg-quick up/down
#
# ============================================================
# ПРОВЕРКА РАБОТЫ
# ============================================================
#
# На сервере:
# sudo awg show awg0
# sudo wg show wg0  # для сравнения с обычным WireGuard
#
# Ping от клиента:
# ping 10.8.2.1  # AmneziaWG сервер
# ping 10.8.1.1  # обычный WireGuard сервер (для сравнения)
#
# Проверка IP:
# curl ifconfig.me  # должен показать IP Oracle Cloud
#
# ============================================================
# TROUBLESHOOTING
# ============================================================
#
# Проблема: AmneziaWG не запускается
# Решение:
#   sudo dmesg | grep amnezia
#   sudo journalctl -u awg-quick@awg0 -f
#
# Проблема: Клиент не может подключиться
# Решение:
#   sudo awg show awg0  # проверить handshake
#   sudo tcpdump -i ens3 udp port 51821  # посмотреть пакеты
#
# Проблема: Подключается, но нет интернета
# Решение:
#   sudo sysctl net.ipv4.ip_forward=1
#   sudo iptables -t nat -L POSTROUTING -n -v  # проверить NAT
#
# ============================================================
# БЕЗОПАСНОСТЬ
# ============================================================
#
# 1. Обязательно изменить все ключи (CHANGE_ME)
# 2. Использовать PresharedKey для дополнительной защиты
# 3. Регулярно обновлять AmneziaWG (безопасность + новая обфускация)
# 4. Мониторить логи: sudo journalctl -u awg-quick@awg0 -f
# 5. Firewall: открыт только порт 51821 UDP
#
# ============================================================
# BACKUP И ВОССТАНОВЛЕНИЕ
# ============================================================
#
# Backup:
# sudo tar -czf amneziawg-backup-$(date +%Y%m%d).tar.gz /etc/amnezia/amneziawg/
# sudo cp /etc/amnezia/amneziawg/awg0.conf ~/amneziawg-backup.conf
#
# Восстановление:
# sudo tar -xzf amneziawg-backup-*.tar.gz -C /
# sudo systemctl restart awg-quick@awg0
