# AmneziaWG Server Configuration (Russia VPS)
# Российский VPS для получения российского IP адреса
# Файл: /etc/amnezia/amneziawg-russia/awg1.conf

[Interface]
Address = 10.9.1.1/24
ListenPort = 51822
PrivateKey = SERVER_PRIVATE_KEY_CHANGE_ME

# Обфускация параметры (отличаются от Oracle Cloud для различения)
# Эти параметры делают трафик похожим на обычный UDP/HTTPS
Jc = 7          # Junk packet count (больше чем у Oracle = 5)
Jmin = 60       # Junk packet min size (60 vs 50 на Oracle)
Jmax = 1200     # Junk packet max size (1200 vs 1000 на Oracle)
S1 = 40         # Init packet junk size (40 vs 30 на Oracle)
S2 = 60         # Response packet junk size (60 vs 50 на Oracle)
H1 = 9876543210 # Init packet magic header (инверсия от Oracle)
H2 = 1234567890 # Response packet magic header (инверсия от Oracle)
H3 = 5544332211 # Underload packet magic header (инверсия от Oracle)
H4 = 1122334455 # Transport packet magic header (инверсия от Oracle)

# Firewall правила (замените eth0 на ваш интерфейс если отличается)
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

# Peer 1: GL-AX1800 Travel Router
[Peer]
PublicKey = GL_AX1800_PUBLIC_KEY_CHANGE_ME
PresharedKey = PRESHARED_KEY_CHANGE_ME
AllowedIPs = 10.9.1.2/32
PersistentKeepalive = 25

# Peer 2: Android Phone (опционально)
#[Peer]
#PublicKey = PHONE_PUBLIC_KEY_CHANGE_ME
#PresharedKey = PRESHARED_KEY_CHANGE_ME
#AllowedIPs = 10.9.1.3/32
#PersistentKeepalive = 25

# Peer 3: Laptop (опционально)
#[Peer]
#PublicKey = LAPTOP_PUBLIC_KEY_CHANGE_ME
#PresharedKey = PRESHARED_KEY_CHANGE_ME
#AllowedIPs = 10.9.1.4/32
#PersistentKeepalive = 25

# Peer 4: Домашняя сеть Proxmox (site-to-site VPN, опционально)
#[Peer]
#PublicKey = HOME_PROXMOX_PUBLIC_KEY_CHANGE_ME
#PresharedKey = PRESHARED_KEY_CHANGE_ME
#AllowedIPs = 10.9.1.10/32, 192.168.10.0/24, 192.168.20.0/24
#PersistentKeepalive = 25

# ============================================================
# ИНСТРУКЦИЯ ПО НАСТРОЙКЕ
# ============================================================

# 1. Установить AmneziaWG на VPS (Ubuntu/Debian):
#
# wget https://github.com/amnezia-vpn/amneziawg-linux-kernel-module/releases/latest/download/amneziawg-install.sh
# chmod +x amneziawg-install.sh
# sudo ./amneziawg-install.sh
#
# Или через PPA:
# sudo add-apt-repository ppa:amnezia/ppa
# sudo apt update
# sudo apt install amneziawg amneziawg-tools

# 2. Создать директорию:
#
# sudo mkdir -p /etc/amnezia/amneziawg-russia
# cd /etc/amnezia/amneziawg-russia

# 3. Создать ключи:
#
# sudo sh -c 'umask 077; awg genkey | tee server_privatekey | awg pubkey > server_publickey'
# sudo sh -c 'awg genpsk > preshared_key'
#
# echo "Server Private Key:"
# sudo cat server_privatekey
#
# echo "Server Public Key:"
# sudo cat server_publickey
#
# echo "Preshared Key:"
# sudo cat preshared_key

# 4. Заменить ключи в этом файле:
#
# SERVER_PRIVATE_KEY_CHANGE_ME = содержимое server_privatekey
# GL_AX1800_PUBLIC_KEY_CHANGE_ME = публичный ключ клиента (создадим позже)
# PRESHARED_KEY_CHANGE_ME = содержимое preshared_key

# 5. Скопировать конфиг:
#
# sudo cp russia-vps-amneziawg.conf /etc/amnezia/amneziawg-russia/awg1.conf
# sudo chmod 600 /etc/amnezia/amneziawg-russia/awg1.conf

# 6. Включить IP forwarding:
#
# sudo sysctl -w net.ipv4.ip_forward=1
# echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf

# 7. Настроить firewall:
#
# # ufw
# sudo ufw allow 51822/udp
# sudo ufw allow 22/tcp  # SSH (или другой порт если изменили)
# sudo ufw enable
#
# # iptables (если не используете ufw)
# sudo iptables -I INPUT -p udp --dport 51822 -j ACCEPT
# sudo iptables -I INPUT -p tcp --dport 22 -j ACCEPT
# sudo netfilter-persistent save

# 8. Запустить и включить автозагрузку:
#
# sudo systemctl enable awg-quick@awg1
# sudo systemctl start awg-quick@awg1

# 9. Проверить статус:
#
# sudo awg show awg1
# sudo systemctl status awg-quick@awg1
# sudo journalctl -u awg-quick@awg1 -f

# ============================================================
# ОПРЕДЕЛЕНИЕ СЕТЕВОГО ИНТЕРФЕЙСА
# ============================================================
#
# По умолчанию используется eth0, но на вашем VPS может быть другой.
# Проверить:
#
# ip route | grep default
# Вывод: default via X.X.X.X dev INTERFACE_NAME
#
# Примеры:
# - Timeweb: обычно eth0
# - REG.RU: обычно eth0
# - Selectel: может быть ens3
#
# Если не eth0, замените в PostUp/PostDown:
# eth0 → ваш интерфейс (например, ens3)

# ============================================================
# ОТЛИЧИЯ ОТ ORACLE CLOUD
# ============================================================
#
# Параметр             | Oracle Cloud  | Russia VPS
# ---------------------|---------------|-------------
# Порт                 | 51821         | 51822
# Подсеть              | 10.8.2.0/24   | 10.9.1.0/24
# Сервер IP            | 10.8.2.1      | 10.9.1.1
# Клиент IP            | 10.8.2.2      | 10.9.1.2
# Jc                   | 5             | 7
# Jmin/Jmax            | 50/1000       | 60/1200
# S1/S2                | 30/50         | 40/60
# H1-H4                | 1234...       | 9876... (инверсия)
# Назначение           | Обход DPI РФ  | Российский IP
#
# Оба могут работать ОДНОВРЕМЕННО на одном VPS!

# ============================================================
# ЗАПУСК ОБОИХ VPN НА ОДНОМ СЕРВЕРЕ (опционально)
# ============================================================
#
# Если Oracle Cloud - это тот же VPS что и Russia VPS:
#
# sudo systemctl enable awg-quick@awg0  # Oracle конфиг
# sudo systemctl enable awg-quick@awg1  # Russia конфиг
# sudo systemctl start awg-quick@awg0
# sudo systemctl start awg-quick@awg1
#
# sudo awg show awg0  # 10.8.2.1, порт 51821
# sudo awg show awg1  # 10.9.1.1, порт 51822
#
# Firewall должен разрешать оба порта:
# sudo ufw allow 51821/udp
# sudo ufw allow 51822/udp

# ============================================================
# ПРОВЕРКА РАБОТЫ
# ============================================================
#
# На сервере:
# sudo awg show awg1
# sudo systemctl status awg-quick@awg1
# sudo ss -ulnp | grep 51822  # проверить что слушает порт
#
# После подключения клиента:
# sudo awg show awg1 latest-handshakes  # должен показать handshake
# sudo awg show awg1 transfer  # статистика трафика
# ping 10.9.1.2  # ping клиента
#
# Проверка что клиент получает российский IP:
# curl ifconfig.me  # с клиента должен показать IP вашего VPS
# curl ipinfo.io  # должен показать город вашего VPS (Москва/СПб)

# ============================================================
# TROUBLESHOOTING
# ============================================================
#
# Проблема: AmneziaWG не запускается
# Решение:
#   sudo dmesg | grep amnezia
#   sudo journalctl -u awg-quick@awg1 -f
#   lsmod | grep amnezia
#
# Проблема: Клиент не может подключиться
# Решение:
#   # На сервере смотреть пакеты
#   sudo tcpdump -i eth0 udp port 51822 -v
#   # Проверить firewall
#   sudo ufw status
#   sudo iptables -L INPUT -n -v | grep 51822
#
# Проблема: Подключается, но нет интернета
# Решение:
#   # Проверить IP forwarding
#   sudo sysctl net.ipv4.ip_forward  # должно быть 1
#   # Проверить NAT
#   sudo iptables -t nat -L POSTROUTING -n -v
#   # Проверить маршруты на клиенте
#   ip route show  # на клиенте
#
# Проблема: Медленная скорость
# Решение:
#   # Уменьшить обфускацию
#   Jc = 3  # было 7
#   Jmax = 800  # было 1200
#
#   # Проверить MTU
#   ip link set awg1 mtu 1420

# ============================================================
# РЕКОМЕНДАЦИИ ПО ХОСТИНГУ
# ============================================================
#
# Timeweb (рекомендую):
#   - VPS-1: 1 CPU, 2GB RAM, 20GB SSD - 200₽/мес
#   - ЦОД: Москва, Санкт-Петербург
#   - https://timeweb.com/ru/services/vps/
#
# REG.RU:
#   - VPS Linux-1: 1 vCPU, 2GB RAM, 25GB SSD - 150₽/мес
#   - https://www.reg.ru/vps/
#
# Selectel:
#   - Cloud Server: 1 vCPU, 2GB RAM - ~500₽/мес
#   - Почасовая оплата
#   - https://selectel.ru/services/cloud/servers/

# ============================================================
# БЕЗОПАСНОСТЬ
# ============================================================
#
# 1. Обязательно изменить SSH порт:
#    sudo nano /etc/ssh/sshd_config
#    Port 2222  # вместо 22
#    sudo systemctl restart sshd
#    sudo ufw allow 2222/tcp
#    sudo ufw delete allow 22/tcp
#
# 2. Установить Fail2ban:
#    sudo apt install -y fail2ban
#    sudo systemctl enable fail2ban
#
# 3. Автообновления безопасности:
#    sudo apt install -y unattended-upgrades
#    sudo dpkg-reconfigure -plow unattended-upgrades
#
# 4. Регулярно обновлять систему:
#    sudo apt update && sudo apt upgrade -y
#
# 5. Мониторинг (простой):
#    crontab -e
#    */5 * * * * systemctl is-active awg-quick@awg1 || systemctl restart awg-quick@awg1

# ============================================================
# BACKUP И ВОССТАНОВЛЕНИЕ
# ============================================================
#
# Backup:
# sudo tar -czf awg-russia-backup-$(date +%Y%m%d).tar.gz /etc/amnezia/amneziawg-russia/
# sudo cp /etc/amnezia/amneziawg-russia/awg1.conf ~/awg-russia-backup.conf
#
# Восстановление:
# sudo tar -xzf awg-russia-backup-*.tar.gz -C /
# sudo systemctl restart awg-quick@awg1

# ============================================================
# МОНИТОРИНГ
# ============================================================
#
# Простой скрипт мониторинга:
#
# #!/bin/bash
# # /usr/local/bin/awg-monitor.sh
#
# if ! systemctl is-active --quiet awg-quick@awg1; then
#     echo "$(date): AmneziaWG Russia не работает, перезапуск..." >> /var/log/awg-monitor.log
#     systemctl restart awg-quick@awg1
# fi
#
# Добавить в cron:
# */5 * * * * /usr/local/bin/awg-monitor.sh

# ============================================================
# ИСПОЛЬЗОВАНИЕ С AMNEZIA VPN APP (GUI)
# ============================================================
#
# Вместо ручной настройки можно использовать Amnezia VPN Server:
# https://github.com/amnezia-vpn/amnezia-server
#
# Docker установка:
# sudo apt install -y docker.io docker-compose
# git clone https://github.com/amnezia-vpn/amnezia-server.git
# cd amnezia-server
# docker-compose up -d
#
# Затем в Amnezia VPN клиенте (Android/iOS/Desktop):
# - Подключиться к серверу по IP
# - Автоматически сгенерирует конфиги
# - QR коды для подключения устройств
