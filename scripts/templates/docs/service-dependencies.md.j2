# Service Dependencies

**Generated from**: topology.yaml v{{ topology_version }}
**Date**: {{ generated_at }}

---

## Service Dependency Graph

```mermaid
flowchart TB
    subgraph mikrotik["MikroTik Chateau"]
        direction TB
        {% for service in services %}
        {% if service.device_ref == 'mikrotik-chateau' %}
        {{ service.id | mermaid_id }}["{{ service.name }}<br/>{{ service.type }}"]
        {% endif %}
        {% endfor %}
    end

    subgraph orangepi["Orange Pi 5"]
        direction TB
        {% for service in services %}
        {% if service.device_ref == 'orangepi5' %}
        {{ service.id | mermaid_id }}["{{ service.name }}<br/>{{ service.type }}"]
        {% endif %}
        {% endfor %}
    end

    subgraph proxmox["Proxmox LXC"]
        direction TB
        {% for service in services %}
        {% if service.lxc_ref is defined %}
        {{ service.id | mermaid_id }}[("{{ service.name }}<br/>{{ service.type }}")]
        {% endif %}
        {% endfor %}
    end

    %% Declared dependencies
    {% for service in services %}
    {% if service.dependencies is defined %}
    {% for dep in service.dependencies %}
    {{ service.id | mermaid_id }} --> {{ dep.service_ref | mermaid_id }}
    {% endfor %}
    {% endif %}
    {% endfor %}

    %% Monitoring dependencies
    svc_grafana --> svc_prometheus
    svc_grafana --> svc_loki
    svc_alertmanager --> svc_prometheus

    %% Styling
    classDef database fill:#4dabf7,stroke:#1864ab,color:#fff
    classDef cache fill:#ffd43b,stroke:#fab005,color:#000
    classDef web fill:#51cf66,stroke:#2b8a3e,color:#000
    classDef monitoring fill:#da77f2,stroke:#9c36b5,color:#fff
    classDef network fill:#ff6b6b,stroke:#c92a2a,color:#fff
    classDef vpn fill:#74c0fc,stroke:#1864ab,color:#000

    {% for service in services %}
    {% if service.type == 'database' %}
    class {{ service.id | mermaid_id }} database
    {% elif service.type == 'cache' %}
    class {{ service.id | mermaid_id }} cache
    {% elif service.type in ['web-application', 'media-server', 'web-ui'] %}
    class {{ service.id | mermaid_id }} web
    {% elif service.type in ['monitoring', 'alerting', 'logging', 'visualization'] %}
    class {{ service.id | mermaid_id }} monitoring
    {% elif service.type == 'dns' %}
    class {{ service.id | mermaid_id }} network
    {% elif service.type == 'vpn' %}
    class {{ service.id | mermaid_id }} vpn
    {% endif %}
    {% endfor %}
```

---

## Service Inventory

| Service | Type | Host | IP:Port | Critical |
|---------|------|------|---------|----------|
{% for service in services %}
| **{{ service.name }}** | {{ service.type }} | {{ service.device_ref | default(service.lxc_ref | default('?')) }} | {{ service.ip | default('?') }}:{{ service.port | default((service.ports.https if service.ports is defined and service.ports.https is defined else (service.ports.http if service.ports is defined and service.ports.http is defined else '?'))) }} | {{ 'Yes' if service.critical else 'No' }} |
{% endfor %}

---

## Dependency Matrix

### Services That Depend On Others

| Service | Depends On | Reason |
|---------|------------|--------|
{% for service in services %}
{% if service.dependencies is defined %}
| **{{ service.name }}** | {% for dep in service.dependencies %}{{ dep.service_ref }}{% if not loop.last %}, {% endif %}{% endfor %} | Backend services |
{% endif %}
{% endfor %}

---

## Services by Host

### MikroTik Chateau (Router)

| Service | Type | Port(s) | Container |
|---------|------|---------|-----------|
{% for service in services %}
{% if service.device_ref == 'mikrotik-chateau' %}
| {{ service.name }} | {{ service.type }} | {{ service.port | default('-') }} | {{ 'Yes' if service.container else 'Native' }} |
{% endif %}
{% endfor %}

### Orange Pi 5 (Application Server)

| Service | Type | Port | Container Image |
|---------|------|------|-----------------|
{% for service in services %}
{% if service.device_ref == 'orangepi5' %}
| {{ service.name }} | {{ service.type }} | {{ service.port | default('-') }} | {{ service.container_image | default('-') }} |
{% endif %}
{% endfor %}

### Proxmox LXC Containers

| Service | Type | LXC | Port |
|---------|------|-----|------|
{% for service in services %}
{% if service.lxc_ref is defined %}
| {{ service.name }} | {{ service.type }} | {{ service.lxc_ref }} | {{ service.port | default('-') }} |
{% endif %}
{% endfor %}

---

## Data Flow

```mermaid
flowchart LR
    subgraph users["Users"]
        browser["Browser"]
        mobile["Mobile App"]
    end

    subgraph services["Services"]
        nextcloud["Nextcloud"]
        jellyfin["Jellyfin"]
        grafana["Grafana"]
    end

    subgraph data["Data Layer"]
        postgresql[("PostgreSQL")]
        redis[("Redis")]
    end

    subgraph monitoring["Monitoring"]
        prometheus["Prometheus"]
        loki["Loki"]
    end

    browser --> nextcloud
    browser --> jellyfin
    browser --> grafana
    mobile --> nextcloud
    mobile --> jellyfin

    nextcloud --> postgresql
    nextcloud --> redis
    grafana --> prometheus
    grafana --> loki

    prometheus -.->|scrape| nextcloud
    prometheus -.->|scrape| jellyfin
    prometheus -.->|scrape| postgresql
    prometheus -.->|scrape| redis
```

---

## Service URLs

| Service | URL | Protocol |
|---------|-----|----------|
{% for service in services %}
{% if service.url is defined %}
| {{ service.name }} | `{{ service.url }}` | {{ service.protocol | upper }} |
{% endif %}
{% endfor %}

---

**DO NOT EDIT MANUALLY** - Regenerate with `python3 scripts/generate-docs.py`
