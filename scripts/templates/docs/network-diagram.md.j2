# Network Diagram

**Generated from**: topology.yaml v{{ topology_version }}
**Date**: {{ generated_at }}

---

## Infrastructure Network Topology

```mermaid
graph TB
    %% ============================================================
    %% Trust Zones
    %% ============================================================

    subgraph UNTRUSTED["Untrusted Zone (Level 0)"]
        INTERNET[("Internet")]
    end

    subgraph SERVERS["Servers Zone (Level 2)"]
        {% for lxc_item in lxc %}
        {% if lxc_item.trust_zone_ref == 'servers' %}
        {{ lxc_item.id | mermaid_id }}["{{ lxc_item.name }}<br/>LXC"]
        {% endif %}
        {% endfor %}
    end

    subgraph USER["User Zone (Level 1)"]
        USERS[("User Devices")]
    end

    subgraph MGMT["Management Zone (Level 3)"]
        PROXMOX["Proxmox VE<br/>hypervisor"]
        MIKROTIK["MikroTik<br/>router"]
    end

    %% ============================================================
    %% Network Bridges (Proxmox)
    %% ============================================================

    {% for bridge in bridges %}
    {{ bridge.id | mermaid_id }}[/"{{ bridge.name }}<br/>{{ bridge.comment | default('bridge') }}"/]
    {% endfor %}

    %% ============================================================
    %% Network Connections
    %% ============================================================

    %% Internet → MikroTik
    INTERNET -.->|WAN| MIKROTIK

    %% MikroTik → Bridges
    MIKROTIK -->|trunk| {{ bridges[0].id | mermaid_id if bridges else 'bridge_vmbr0' }}

    %% Bridges to LXC
    {% for lxc_item in lxc %}
    {% for nic in lxc_item.networks %}
    {{ nic.bridge_ref | mermaid_id }} <-->|{{ nic.ip.split('/')[0] }}| {{ lxc_item.id | mermaid_id }}
    {% endfor %}
    {% endfor %}

    %% Proxmox management
    PROXMOX <--> {{ bridges[0].id | mermaid_id if bridges else 'bridge_vmbr0' }}

    %% User to network
    USERS -.->|WiFi/LAN| MIKROTIK

    %% Styling
    classDef untrusted fill:#ff6b6b,stroke:#c92a2a,color:#fff
    classDef servers fill:#51cf66,stroke:#2b8a3e,color:#000
    classDef user fill:#74c0fc,stroke:#1864ab,color:#000
    classDef mgmt fill:#da77f2,stroke:#9c36b5,color:#fff
    classDef bridge fill:#e9ecef,stroke:#868e96,color:#000

    class INTERNET untrusted
    class USERS user
    class PROXMOX,MIKROTIK mgmt
    {% set server_nodes = lxc | selectattr('trust_zone_ref', 'equalto', 'servers') | map(attribute='id') | map('mermaid_id') | list %}
    {% if server_nodes %}
    class {{ server_nodes | join(',') }} servers
    {% endif %}
    {% set bridge_nodes = bridges | map(attribute='id') | map('mermaid_id') | list %}
    {% if bridge_nodes %}
    class {{ bridge_nodes | join(',') }} bridge
    {% endif %}
```

---

## Trust Zones Explanation

| Zone | Level | Purpose | Devices |
|------|-------|---------|---------|
{% for zone_id, zone_config in trust_zones.items() %}
| {{ zone_id | title }} | {{ zone_config.security_level | default('') }} | {{ zone_config.description }} | {% set zone_devices = [] %}{% for vm in vms %}{% if vm.trust_zone_ref == zone_id %}{% set _ = zone_devices.append(vm.name) %}{% endif %}{% endfor %}{% for lxc_item in lxc %}{% if lxc_item.trust_zone_ref == zone_id %}{% set _ = zone_devices.append(lxc_item.name) %}{% endif %}{% endfor %}{{ zone_devices | join(', ') if zone_devices else 'None' }} |
{% endfor %}

---

## Network Details

{% for network in networks %}
### {{ network.id }}

- **CIDR**: {{ network.cidr }}
- **Bridge**: {{ network.bridge_ref }}
- **Trust Zone**: {{ network.trust_zone_ref }}
{% if network.gateway %}
- **Gateway**: {{ network.gateway }}
{% endif %}
{% if network.vlan %}
- **VLAN**: {{ network.vlan }}
{% endif %}

{% if network.ip_allocations %}
**Allocated IPs**:
{% for alloc in network.ip_allocations | sort(attribute='ip') %}
- `{{ alloc.ip }}` → {{ alloc.device_ref | default(alloc.vm_ref | default(alloc.lxc_ref)) }} ({{ alloc.interface }})
{% endfor %}
{% endif %}

---

{% endfor %}

---

**DO NOT EDIT MANUALLY** - Regenerate with `python3 scripts/generate-docs.py`
