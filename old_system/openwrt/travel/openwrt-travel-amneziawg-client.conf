# AmneziaWG Client Configuration (GL-AXT1800 Travel Router)
# Для поездок по России (обход DPI блокировок)
# Файл: /etc/amnezia/amneziawg/awg0.conf

[Interface]
PrivateKey = CLIENT_PRIVATE_KEY_CHANGE_ME
Address = 10.8.2.2/24
DNS = 192.168.10.1

# Обфускация параметры (ДОЛЖНЫ СОВПАДАТЬ с сервером!)
Jc = 5
Jmin = 50
Jmax = 1000
S1 = 30
S2 = 50
H1 = 1234567890
H2 = 9876543210
H3 = 1122334455
H4 = 5544332211

[Peer]
PublicKey = SERVER_PUBLIC_KEY_CHANGE_ME
PresharedKey = PRESHARED_KEY_CHANGE_ME
Endpoint = ORACLE_CLOUD_IP:51821
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25

# ============================================================
# ИНСТРУКЦИЯ ПО НАСТРОЙКЕ GL-AXT1800
# ============================================================

# 1. Подключиться по SSH к роутеру:
#
# ssh root@192.168.100.1  # в поездке
# или
# ssh root@192.168.20.1   # дома

# 2. Установить AmneziaWG:
#
# opkg update
#
# # Скачать пакет для MediaTek MT7621 (GL-AXT1800)
# cd /tmp
# wget https://github.com/amnezia-vpn/amneziawg-linux-kernel-module/releases/download/v1.0.20231030/kmod-amneziawg_5.10.176-1_mipsel_24kc.ipk
# wget https://github.com/amnezia-vpn/amneziawg-tools/releases/download/v1.0.20231030/amneziawg-tools_1.0.20231030-1_mipsel_24kc.ipk
#
# opkg install kmod-amneziawg_*.ipk
# opkg install amneziawg-tools_*.ipk

# 3. Создать директорию:
#
# mkdir -p /etc/amnezia/amneziawg

# 4. Создать ключи на роутере:
#
# cd /etc/amnezia/amneziawg
# awg genkey | tee client_privatekey | awg pubkey > client_publickey
# cat client_publickey  # скопировать и добавить на сервер

# 5. Скопировать этот конфиг на роутер:
#
# # На компьютере:
# scp openwrt-travel-amneziawg-client.conf root@192.168.100.1:/etc/amnezia/amneziawg/awg0.conf
#
# # На роутере:
# chmod 600 /etc/amnezia/amneziawg/awg0.conf

# 6. Заменить ключи в конфиге:
#
# nano /etc/amnezia/amneziawg/awg0.conf
#
# CLIENT_PRIVATE_KEY_CHANGE_ME = содержимое client_privatekey
# SERVER_PUBLIC_KEY_CHANGE_ME = содержимое server_publickey с Oracle Cloud
# PRESHARED_KEY_CHANGE_ME = содержимое preshared_key
# ORACLE_CLOUD_IP = публичный IP вашего Oracle Cloud сервера

# 7. Запустить вручную (для теста):
#
# awg-quick up awg0
#
# # Проверить:
# awg show awg0
# ping 10.8.2.1  # ping сервера
# curl ifconfig.me  # должен показать IP Oracle Cloud

# 8. Остановить:
#
# awg-quick down awg0

# ============================================================
# ИНТЕГРАЦИЯ С /etc/config/network
# ============================================================

# Добавить в /etc/config/network:

# config interface 'amneziavpn'
#     option proto 'none'
#     option device 'awg0'
#     option auto '0'

# ============================================================
# АВТОЗАПУСК (через /etc/rc.local или init script)
# ============================================================

# Вариант 1: Через rc.local
#
# echo "awg-quick up awg0 &" >> /etc/rc.local

# Вариант 2: Через init script (лучше)
#
# Создать /etc/init.d/amneziawg:

#!/bin/sh /etc/rc.common
# START=99
# STOP=10
#
# start() {
#     awg-quick up awg0
# }
#
# stop() {
#     awg-quick down awg0
# }
#
# restart() {
#     stop
#     sleep 2
#     start
# }

# chmod +x /etc/init.d/amneziawg
# /etc/init.d/amneziawg enable

# ============================================================
# ROUTING - ВЕСЬ ТРАФИК ЧЕРЕЗ VPN
# ============================================================

# AmneziaWG автоматически создаёт маршруты через AllowedIPs = 0.0.0.0/0
# Проверить маршруты:
#
# ip route show
# ip route show table all

# Если маршруты не создаются автоматически, добавить вручную:
#
# ip route add 0.0.0.0/1 dev awg0
# ip route add 128.0.0.0/1 dev awg0

# ============================================================
# DNS ЧЕРЕЗ VPN
# ============================================================

# Обновить /etc/config/dhcp:
#
# config dnsmasq
#     option noresolv '1'
#     list server '192.168.10.1'  # AdGuard дома через VPN

# Перезапустить dnsmasq:
# /etc/init.d/dnsmasq restart

# ============================================================
# FIREWALL
# ============================================================

# Обновить /etc/config/firewall:

# config zone
#     option name 'vpn'
#     option input 'ACCEPT'
#     option output 'ACCEPT'
#     option forward 'REJECT'
#     option masq '1'
#     option mtu_fix '1'
#     list network 'amneziavpn'
#
# config forwarding
#     option src 'lan'
#     option dest 'vpn'

# Перезапустить firewall:
# /etc/init.d/firewall restart

# ============================================================
# ПРОВЕРКА РАБОТЫ
# ============================================================

# 1. Статус интерфейса:
# awg show awg0
# ip addr show awg0

# 2. Проверка handshake (должен быть недавний):
# awg show awg0 | grep "latest handshake"

# 3. Ping сервера:
# ping -c 5 10.8.2.1

# 4. Проверка внешнего IP:
# curl ifconfig.me
# curl ipinfo.io

# 5. Проверка DNS:
# nslookup google.com 192.168.10.1

# 6. Проверка маршрутов:
# ip route get 8.8.8.8

# 7. Traceroute:
# traceroute -n 8.8.8.8
# # Первый hop должен быть 10.8.2.1 (VPN сервер)

# ============================================================
# СРАВНЕНИЕ С WIREGUARD
# ============================================================

# WireGuard (oracle-cloud-wireguard.conf):
#   - Интерфейс: wg0
#   - Подсеть: 10.8.1.0/24
#   - Порт: 51820
#   - Команды: wg, wg-quick
#   - Блокируется DPI в РФ
#
# AmneziaWG (этот файл):
#   - Интерфейс: awg0
#   - Подсеть: 10.8.2.0/24
#   - Порт: 51821
#   - Команды: awg, awg-quick
#   - Обходит DPI благодаря обфускации

# ============================================================
# TROUBLESHOOTING
# ============================================================

# Проблема: awg команда не найдена
# Решение:
#   opkg list-installed | grep amnezia
#   which awg
#   export PATH=$PATH:/usr/bin

# Проблема: Модуль ядра не загружается
# Решение:
#   dmesg | grep amnezia
#   lsmod | grep amnezia
#   insmod /lib/modules/*/amneziawg.ko

# Проблема: Подключается, но нет интернета
# Решение:
#   ip route show  # проверить маршруты
#   iptables -t nat -L -n -v  # проверить NAT
#   cat /etc/resolv.conf  # проверить DNS

# Проблема: Handshake не происходит
# Решение:
#   awg show awg0  # смотреть latest handshake
#   tcpdump -i eth1 udp port 51821  # смотреть пакеты
#   ping 10.8.2.1  # ping через VPN
#   # Проверить firewall на Oracle Cloud

# Проблема: Работает, но медленно
# Решение:
#   # Проверить MTU
#   ip link show awg0
#   ip link set awg0 mtu 1420
#
#   # Отключить hardware offloading (если проблемы)
#   ethtool -K eth1 gso off tso off

# ============================================================
# ПЕРЕКЛЮЧЕНИЕ МЕЖДУ WIREGUARD И AMNEZIAWG
# ============================================================

# См. скрипт openwrt-amneziawg-failover.sh

# Вручную:
#
# # Использовать обычный WireGuard:
# awg-quick down awg0
# wg-quick up wg0
#
# # Использовать AmneziaWG:
# wg-quick down wg0
# awg-quick up awg0

# ============================================================
# ОБНОВЛЕНИЕ AMNEZIAWG
# ============================================================

# Периодически проверять обновления:
# https://github.com/amnezia-vpn/amneziawg-linux-kernel-module/releases
#
# Обновление:
# opkg update
# opkg upgrade amneziawg-tools kmod-amneziawg
#
# Или скачать новый .ipk и установить:
# opkg install --force-reinstall amneziawg-tools_*.ipk

# ============================================================
# ДОПОЛНИТЕЛЬНАЯ БЕЗОПАСНОСТЬ
# ============================================================

# 1. Изменить обфускацию параметры (согласовать с сервером):
#    Jc, Jmin, Jmax, S1, S2, H1-H4
#    Уникальные значения усложняют fingerprinting
#
# 2. Регулярно менять PresharedKey:
#    awg genpsk > new_psk
#    # Обновить на сервере и клиенте
#
# 3. Мониторинг соединения:
#    watch -n 5 'awg show awg0'
#
# 4. Kill switch (если VPN упал - блокировать интернет):
#    См. openwrt-travel-firewall для примера

# ============================================================
# ПОЛЕЗНЫЕ ССЫЛКИ
# ============================================================

# AmneziaWG GitHub:
# https://github.com/amnezia-vpn/amneziawg-linux-kernel-module
#
# AmneziaWG Tools:
# https://github.com/amnezia-vpn/amneziawg-tools
#
# Документация:
# https://docs.amnezia.org/
#
# OpenWRT форум:
# https://forum.openwrt.org/
